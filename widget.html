<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custom Agent Setup</title>
  <!-- Tailwind via CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{color-scheme: dark;}
    body{background:#0e0f13;color:#e7e7ea}
    .card{background:#151720;border:1px solid #242733;border-radius:16px}
    .btn{background:#ff7a00;color:#0b0c10;border-radius:12px;padding:.6rem 1rem;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#242733;color:#e7e7ea}
    .link{color:#c9d4ff;text-decoration:underline}
    .dropzone{border:2px dashed #2e3344;border-radius:16px;padding:2.25rem;text-align:center;transition:all .15s ease}
    .dropzone.dragover{background:#1a1d27;border-color:#3f4660}
    .toast{position:fixed;right:18px;bottom:18px;background:#1b1e28;border:1px solid #2b3042;border-radius:12px;padding:.8rem 1rem;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toast h4{font-weight:700;margin:0 0 .25rem 0}
    .badge{display:inline-block;background:#23283a;border:1px solid #2e3346;border-radius:10px;padding:.15rem .5rem;font-size:.75rem}
    .muted{color:#a7adbe}
    .input{background:#10121a;border:1px solid #262b3c;border-radius:10px;padding:.55rem .7rem}
    progress::-webkit-progress-value{background:#ff7a00}
    progress::-webkit-progress-bar{background:#2a2f41;border-radius:10px}
  </style>
</head>
<body class="min-h-screen">
  <main class="max-w-5xl mx-auto px-5 py-10 space-y-6">

    <header class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold">Custom Agent Setup</h1>
        <p id="ctx" class="muted text-sm mt-1"></p>
      </div>
      <a id="dashLink" class="btn btn-secondary whitespace-nowrap" href="#" target="_blank" rel="noopener">Open dashboard for this location</a>
    </header>

    <!-- Fetch preview / health -->
    <section class="card p-5">
      <div class="flex items-center justify-between">
        <div class="space-y-1">
          <h2 class="text-lg font-bold">Connection</h2>
          <p class="muted text-sm">We’ll ping <span class="badge" id="fetchHost">fetchUrl</span> with your auth header to verify connectivity.</p>
        </div>
        <button id="testBtn" class="btn btn-secondary">Test connection</button>
      </div>
      <div id="testResult" class="mt-4 text-sm whitespace-pre-wrap"></div>
    </section>

    <!-- Upload CSV -->
    <section class="card p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Upload CSV File</h2>
        <button id="templateBtn" class="btn btn-secondary">Get Template</button>
      </div>

      <div id="dropzone" class="dropzone mt-4">
        <div class="mx-auto w-12 h-12 mb-3 opacity-70">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3l3.5 3.5-1.41 1.41L13 6.83V14h-2V6.83L9.91 7.91 8.5 6.5 12 3z"></path>
            <path d="M5 18h14v2H5z"></path>
          </svg>
        </div>
        <p class="font-semibold">Drag & drop your CSV here, or <button id="browse" class="link">click to browse</button></p>
        <input id="fileInput" type="file" accept=".csv,text/csv" class="hidden" />
      </div>

      <div class="mt-4">
        <label class="text-xs uppercase tracking-wide muted">Upload</label>
        <div id="uploadState" class="mt-1 text-sm">Not started</div>
        <progress id="progress" max="100" value="0" class="w-full h-2 rounded mt-2"></progress>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="sendBtn" class="btn">Send</button>
        <button id="saveBtn" class="btn btn-secondary">Save (Page)</button>
      </div>
    </section>

    <!-- Hidden simple form values (shown for transparency) -->
    <section class="card p-5">
      <h2 class="text-lg font-bold mb-3">Context</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block">
          <span class="muted text-sm">Location ID</span>
          <input id="locField" class="input w-full mt-1" readonly />
        </label>
        <label class="block">
          <span class="muted text-sm">Business Name</span>
          <input id="bizField" class="input w-full mt-1" readonly />
        </label>
        <label class="block md:col-span-2">
          <span class="muted text-sm">Auth header / token</span>
          <input id="authPreview" class="input w-full mt-1" readonly />
        </label>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden">
    <h4 id="toastTitle"></h4>
    <div id="toastMsg" class="muted"></div>
  </div>

  <script>
    // --- Utilities -----------------------------------------------------------
    const $ = sel => document.querySelector(sel);
    const qs = new URLSearchParams(location.search);

    const ctx = {
      locationId: qs.get('locationId') || '',
      businessName: qs.get('businessName') || '',
      fetchUrl: qs.get('fetchUrl') ? decodeURIComponent(qs.get('fetchUrl')) : '',
      submitUrl: qs.get('submitUrl') ? decodeURIComponent(qs.get('submitUrl')) : '',
      uploadUrl: qs.get('uploadUrl') ? decodeURIComponent(qs.get('uploadUrl')) : '',
      authHeader: qs.get('authHeader') || 'Authorization',
      authToken: qs.get('authToken') || '',
      dashboardUrl: qs.get('dashboardUrl') ? decodeURIComponent(qs.get('dashboardUrl')) : ''
    };

    function authHeaders(extra = {}) {
      const h = new Headers({
        Accept: 'application/json',
        [ctx.authHeader]: ctx.authToken,
        ...extra
      });
      return h;
    }

    function toast(title, msg, isError=false) {
      $('#toast').classList.remove('hidden');
      $('#toastTitle').textContent = title;
      $('#toastMsg').textContent = msg || '';
      $('#toast').style.borderColor = isError ? '#5a1120' : '#2b3042';
      $('#toast').style.background = isError ? '#2a0f18' : '#1b1e28';
      setTimeout(() => $('#toast').classList.add('hidden'), 3500);
    }

    function setUploadState(text){ $('#uploadState').textContent = text; }

    function filenameFromPath(path) {
      return (path || '').split('/').pop();
    }

    // Create a client-side CSV template if the API doesn't provide one.
    function buildLocalTemplate() {
      const header = [
        'first_name','last_name','phone','email','notes'
      ];
      const sample = [
        'Alex','Rios','+1-555-123-0000','alex@example.com','VIP'
      ];
      return header.join(',') + '\n' + sample.join(',') + '\n';
    }

    function download(filename, text) {
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // --- Init UI -------------------------------------------------------------
    (function init(){
      $('#ctx').textContent = `Location: ${ctx.locationId || '—'}  •  Business: ${ctx.businessName || '—'}`;
      $('#fetchHost').textContent = ctx.fetchUrl ? new URL(ctx.fetchUrl).host : '—';
      $('#locField').value = ctx.locationId;
      $('#bizField').value = ctx.businessName;
      $('#authPreview').value = `${ctx.authHeader}: ${ctx.authToken ? ctx.authToken.slice(0, 12)+'…' : ''}`;

      // dashboard link
      if (ctx.dashboardUrl) {
        $('#dashLink').href = ctx.dashboardUrl;
      } else {
        // Hide if not provided
        $('#dashLink').classList.add('hidden');
      }
    })();

    // --- Connection Test -----------------------------------------------------
    $('#testBtn').addEventListener('click', async () => {
      const out = $('#testResult');
      out.textContent = 'Testing…';
      try {
        if (!ctx.fetchUrl) throw new Error('Missing fetchUrl');
        const res = await fetch(ctx.fetchUrl, { method: 'GET', headers: authHeaders() });
        const text = await res.text();
        out.textContent = `Status: ${res.status}\n\n` + (text.slice(0, 2000) || '(empty response)');
        toast('Connection tested', `Status ${res.status}`);
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || e);
        toast('Connection failed', e?.message || String(e), true);
      }
    });

    // --- Template Download ---------------------------------------------------
    $('#templateBtn').addEventListener('click', async () => {
      try {
        // Try to fetch a server-provided template first.
        if (ctx.fetchUrl) {
          const url = new URL(ctx.fetchUrl);
          url.searchParams.set('template', 'true');
          const res = await fetch(url.toString(), { headers: authHeaders() });
          if (res.ok) {
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('text/csv')) {
              const text = await res.text();
              download('import_template.csv', text);
              toast('Template downloaded', 'From server');
              return;
            }
            // Try JSON shape like { columns: ["a","b"] }
            if (ct.includes('application/json')) {
              const json = await res.json();
              if (Array.isArray(json.columns) && json.columns.length) {
                const csv = json.columns.join(',') + '\n';
                download('import_template.csv', csv);
                toast('Template generated', 'From server columns');
                return;
              }
            }
          }
        }
        // Fallback local template
        download('import_template.csv', buildLocalTemplate());
        toast('Template generated', 'Default columns used');
      } catch (e) {
        download('import_template.csv', buildLocalTemplate());
        toast('Template generated', 'Fallback due to error', true);
      }
    });

    // --- Drag & Drop ---------------------------------------------------------
    const dz = $('#dropzone');
    const fileInput = $('#fileInput');
    const browseBtn = $('#browse');
    let fileRef = null;

    function useFile(file){
      if (!file) return;
      fileRef = file;
      setUploadState(`Ready: ${file.name} (${(file.size/1024).toFixed(1)} KB)`);
    }

    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => useFile(e.target.files?.[0]));

    ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover');
    }));
    ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover');
    }));
    dz.addEventListener('drop', e => {
      const file = e.dataTransfer.files?.[0];
      if (file && /\.csv$/i.test(file.name)) useFile(file);
      else toast('Unsupported file', 'Please drop a .csv file', true);
    });

    // --- Send (upload & trigger) --------------------------------------------
    $('#sendBtn').addEventListener('click', async () => {
      try {
        if (!ctx.uploadUrl) throw new Error('Missing uploadUrl');
        if (!fileRef) throw new Error('No file selected');

        $('#sendBtn').disabled = true;
        setUploadState('Uploading…');
        $('#progress').value = 12;

        const form = new FormData();
        form.append('file', fileRef, fileRef.name);
        form.append('locationId', ctx.locationId || '');
        form.append('businessName', ctx.businessName || '');

        // Using fetch without manual Content-Type (browser will set proper multipart boundary).
        const res = await fetch(ctx.uploadUrl, {
          method: 'POST',
          headers: authHeaders(), // safe with multipart
          body: form
        });

        $('#progress').value = 70;

        const ct = res.headers.get('content-type') || '';
        const payload = ct.includes('application/json') ? await res.json() : await res.text();

        $('#progress').value = 100;

        if (!res.ok) {
          throw new Error((payload && (payload.message || payload.error)) || `HTTP ${res.status}`);
        }

        setUploadState(`Done: ${filenameFromPath(fileRef.name)} uploaded`);
        toast('Upload complete', 'Agent triggered successfully');
      } catch (e) {
        $('#progress').value = 0;
        setUploadState('Failed');
        toast('Upload failed', e?.message || String(e), true);
      } finally {
        $('#sendBtn').disabled = false;
      }
    });

    // --- Save (Page) ---------------------------------------------------------
    $('#saveBtn').addEventListener('click', async () => {
      try {
        if (!ctx.submitUrl) throw new Error('Missing submitUrl');

        $('#saveBtn').disabled = true;

        const payload = {
          locationId: ctx.locationId || null,
          businessName: ctx.businessName || null,
          savedAt: new Date().toISOString(),
          // You can add more fixed config fields here if the backend expects them:
          // e.g., agentType, campaignId, etc.
        };

        const res = await fetch(ctx.submitUrl, {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload)
        });

        const ct = res.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await res.json() : await res.text();

        if (!res.ok) {
          throw new Error((data && (data.message || data.error)) || `HTTP ${res.status}`);
        }

        toast('Saved', 'Page configuration saved');
      } catch (e) {
        toast('Save failed', e?.message || String(e), true);
      } finally {
        $('#saveBtn').disabled = false;
      }
    });
  </script>
</body>
</html>
