<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36; --orange:#ed6c03; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }

  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }

  /* Sticky tab bar */
  .tabs-wrap{ position:sticky; top:0; z-index:20; padding:10px 0 8px; background:linear-gradient(var(--bg), rgba(15,17,21,.92)); backdrop-filter: blur(2px); }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{
    border:1px solid var(--line);
    padding:10px 14px;
    border-radius:999px;
    background:#0e1117;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    color:#cfd6e4;
    transition:.15s;
  }
  .tab:hover{ border-color:#3a404a; }
  .tab.active{
    background:var(--orange);
    color:#000;
    border-color:var(--orange);
    box-shadow:0 6px 16px rgba(237,108,3,.35);
  }

  /* Current agent chip */
  .editing{ display:flex; align-items:center; gap:10px; margin:10px 0 12px; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; font-weight:700;
    background:rgba(237,108,3,.14); color:#ffd9b8; border:1px solid rgba(237,108,3,.45);
  }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }

  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{
    width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
  }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .actions{ display:flex; align-items:center; gap:12px; margin-top:14px; }
  .btn{ background:var(--orange); color:#000; border:0; padding:10px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
  .ghost{ background:transparent; color:#fff; border:1px solid var(--line); }
  .status{ font-size:13px; color:var(--muted); }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Spinner */
  .spinner{ width:18px; height:18px; border:3px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:50%; animation:spin .9s linear infinite; display:inline-block; vertical-align:-3px; margin-right:6px; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Per-field token inserter */
  .ti{ display:flex; gap:8px; align-items:center; margin:6px 0 8px; }
  .ti select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .ti button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* Current value chip */
  .cv{ margin-top:6px; font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #2a2f37; color:#9aa3b5; background:#0f141a; display:inline-block; }
  .cv strong{ color:#cdd6e4; font-weight:700; }
  .cv.has-value{ border-color:rgba(237,108,3,.5); background:rgba(237,108,3,.1); color:#ffd9b8; }

</style>
</head>
<body>
  <div class="wrap">
    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <!-- Tabs -->
    <div class="tabs-wrap">
      <div class="tabs" id="tabs"></div>
    </div>

    <!-- Editing indicator -->
    <div class="editing">
      <span class="sub">Editing:</span>
      <span class="chip" id="agentChip">Custom campaign agent 1</span>
    </div>

    <div class="card">
      <!-- Active toggle -->
      <label>Active? ("Yes" or leave blank)</label>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv" id="cv_active"><strong>Current value:</strong> (not set)</div>

      <!-- Campaign name -->
      <label>Campaign name</label>
      <div class="ti" data-target="campaignName">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv" id="cv_campaign"><strong>Current value:</strong> (not set)</div>

      <!-- Per day + Cadence -->
      <div class="row">
        <div>
          <label>How many per day (See SOP)</label>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>150</option><option>200</option><option>250</option><option>300</option>
            <option>350</option><option>500</option><option selected>100</option>
          </select>
          <div class="cv" id="cv_perday"><strong>Current value:</strong> (not set)</div>
        </div>
        <div>
          <label>Follow up cadence</label>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv" id="cv_cadence"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <!-- Messages -->
      <label>First message</label>
      <div class="ti" data-target="firstMessage">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="firstMessage" class="big" placeholder="Type the first message…"></textarea>
      <div class="cv" id="cv_firstmsg"><strong>Current value:</strong> (not set)</div>

      <label>Bump 1</label>
      <div class="ti" data-target="bump1">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump1" class="big" placeholder="Bump 1…"></textarea>
      <div class="cv" id="cv_bump1"><strong>Current value:</strong> (not set)</div>

      <label>Bump 2</label>
      <div class="ti" data-target="bump2">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump2" class="big" placeholder="Bump 2…"></textarea>
      <div class="cv" id="cv_bump2"><strong>Current value:</strong> (not set)</div>

      <label>Bump 3</label>
      <div class="ti" data-target="bump3">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump3" class="big" placeholder="Bump 3…"></textarea>
      <div class="cv" id="cv_bump3"><strong>Current value:</strong> (not set)</div>

      <!-- Notes (plain text) -->
      <label>Notes about campaign</label>
      <div class="ti" data-target="notes">
        <select>
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="notes" class="big" placeholder="Write notes/prompts here…"></textarea>
      <div class="cv" id="cv_notes"><strong>Current value:</strong> (not set)</div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn" id="submitBtn">Save Agent 1</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
        <span class="status" id="status"></span>
      </div>
    </div>
  </div>

<script>
  /* ------------------- CONFIG ------------------- */
  const FETCH_URL  = "https://api.visquanta.com/webhook/call-value-data";
  const SUBMIT_URL = "https://api.visquanta.com/webhook/custom-agent-set-up";
  const AGENT_COUNT = 5;
  /* ---------------------------------------------- */

  // Helpers
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";
  const locationId   = get("locationId");
  const businessName = get("businessName");

  // Header lines
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  // Build tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENT_COUNT;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Agent ${i}`;
    t.dataset.agent = i;
    t.setAttribute("aria-selected", i===1 ? "true" : "false");
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const agentChip    = document.getElementById("agentChip");
  const toggle       = document.getElementById("activeToggle");
  const activeLabel  = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");
  const perDay       = document.getElementById("perDay");
  const cadence      = document.getElementById("cadence");
  const firstMessage = document.getElementById("firstMessage");
  const bump1        = document.getElementById("bump1");
  const bump2        = document.getElementById("bump2");
  const bump3        = document.getElementById("bump3");
  const notes        = document.getElementById("notes");
  const statusEl     = document.getElementById("status");
  const submitBtn    = document.getElementById("submitBtn");

  // "Current value" chips
  const cv = {
    active:  document.getElementById("cv_active"),
    campaign:document.getElementById("cv_campaign"),
    perday:  document.getElementById("cv_perday"),
    cadence: document.getElementById("cv_cadence"),
    firstmsg:document.getElementById("cv_firstmsg"),
    bump1:   document.getElementById("cv_bump1"),
    bump2:   document.getElementById("cv_bump2"),
    bump3:   document.getElementById("cv_bump3"),
    notes:   document.getElementById("cv_notes"),
  };

  // Per-agent working and current
  const working = {};
  const current = {};

  // Toggle helpers
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token inserter: attach to every .ti
  function insertTokenInto(el, token){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    const cur   = el.value || "";
    el.value = cur.slice(0,start) + token + cur.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
  }
  document.querySelectorAll(".ti").forEach(ti=>{
    const target = document.getElementById(ti.dataset.target);
    const sel = ti.querySelector("select");
    const btn = ti.querySelector("button");
    btn.addEventListener("click", ()=> insertTokenInto(target, sel.value));
  });

  // Reset
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    campaignName.value=""; perDay.value="100"; cadence.selectedIndex=0;
    firstMessage.value=""; bump1.value=""; bump2.value=""; bump3.value=""; notes.value="";
    setActive(false); setStatus("");
  });

  function setStatus(text, ok){
    if (!text){ statusEl.textContent=""; return; }
    statusEl.textContent = text;
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setLoading(text="Updating…"){
    statusEl.innerHTML = `<span class="spinner"></span>${text}`;
  }
  function setCV(el, value){
    const has = !!value;
    el.innerHTML = `<strong>Current value:</strong> ${has ? String(value) : "(not set)"}`;
    el.classList.toggle("has-value", has);
  }

  // Keys for an agent
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:   base + "active_yes_or_leave_blank",
      bump1:    base + "bump_1",
      bump2:    base + "bump_2",
      bump3:    base + "bump_3",
      campaign: base + "campaign_name",
      firstmsg: base + "first_message",
      cadence:  base + "follow_up_cadence",
      perday:   base + "how_many_per_day_see_sop",
      notes:    base + "notes_about_campaign"
    };
  }
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`);
      if (q) map[field] = q;
    }
    return map;
  }

  let agent = 1;

  function renderCV(){
    setCV(cv.active,  current[agent]?.active);
    setCV(cv.campaign,current[agent]?.campaign);
    setCV(cv.perday,  current[agent]?.perday);
    setCV(cv.cadence, current[agent]?.cadence);
    setCV(cv.firstmsg,current[agent]?.firstmsg);
    setCV(cv.bump1,   current[agent]?.bump1);
    setCV(cv.bump2,   current[agent]?.bump2);
    setCV(cv.bump3,   current[agent]?.bump3);
    setCV(cv.notes,   current[agent]?.notes);
  }

  // Switch tabs
  function switchAgent(n){
    // Save previous
    working[agent] = getFormValues();

    // Activate
    [...tabsEl.children].forEach(btn=>{
      const is = Number(btn.dataset.agent)===n;
      btn.classList.toggle("active", is);
      btn.setAttribute("aria-selected", is ? "true" : "false");
    });
    agent = n;
    agentChip.textContent = `Custom campaign agent ${agent}`;
    submitBtn.textContent = `Save Agent ${agent}`;
    document.title = `Agent ${agent} • Custom agent set up`;

    // Fill form with working or defaults/current
    const w = working[agent] || {};
    campaignName.value = w.campaign || "";
    perDay.value = w.perday || (current[agent]?.perday || "100");
    cadence.value = w.cadence || (current[agent]?.cadence || "IM > 15m > 24h > 24h");
    firstMessage.value = w.firstmsg || "";
    bump1.value = w.bump1 || "";
    bump2.value = w.bump2 || "";
    bump3.value = w.bump3 || "";
    notes.value = w.notes || "";
    setActive( (w.active ?? (current[agent]?.active?.toLowerCase()==="yes")) ? true:false );

    renderCV();
    setStatus("");
  }

  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      perday:   perDay.value,
      cadence:  cadence.value,
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.value
    };
  }

  // Submit + auto-refresh
  document.getElementById("submitBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);

    working[agent] = getFormValues();
    let keys = overrideKeysFromQuery(cvKeys(agent), agent);

    const payload = {
      locationId, businessName, agent, keys,
      data: {
        ["Custom campaign agent " + agent + " – Active"]: working[agent].active,
        ["Custom campaign agent " + agent + " – Campaign name"]: working[agent].campaign,
        ["Custom campaign agent " + agent + " – How many per day"]: working[agent].perday,
        ["Custom campaign agent " + agent + " – Follow up cadence"]: working[agent].cadence,
        ["Custom campaign agent " + agent + " – First message"]: working[agent].firstmsg,
        ["Custom campaign agent " + agent + " – Bump 1"]: working[agent].bump1,
        ["Custom campaign agent " + agent + " – Bump 2"]: working[agent].bump2,
        ["Custom campaign agent " + agent + " – Bump 3"]: working[agent].bump3,
        ["Custom campaign agent " + agent + " – Notes about campaign"]: working[agent].notes
      }
    };

    submitBtn.disabled = true;
    setLoading("Updating…");

    try{
      const res = await fetch(SUBMIT_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=> ({}));

      if (!res.ok){
        setStatus(`Error ${res.status}: ${json?.message || "Request failed"}`);
      } else if (String(json?.response).toLowerCase()==="complete"){
        setStatus("Saved. Refreshing…", true);
        // wait 3s then refetch latest
        setTimeout(refreshFromServer, 3000);
      } else {
        setStatus("Saved", true);
        setTimeout(refreshFromServer, 3000);
      }
    }catch{
      setStatus("Network error. Try again.");
    }finally{
      submitBtn.disabled = false;
    }
  });

  // Refresh current values from server and update chips (no form wipe)
  async function refreshFromServer(){
    if (!locationId) return;
    const urlWithBust = FETCH_URL + (FETCH_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    try{
      const res = await fetch(urlWithBust, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ locationId })
      });
      const json = await res.json().catch(()=> ({}));
      const agents = json?.agents || {};
      for (let i=1;i<=AGENT_COUNT;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? "",
          campaign: a.campaign ?? "",
          perday:   a.perday ?? "",
          cadence:  a.cadence ?? "",
          firstmsg: a.firstmsg ?? "",
          bump1:    a.bump1 ?? "",
          bump2:    a.bump2 ?? "",
          bump3:    a.bump3 ?? "",
          notes:    a.notes ?? ""
        };
      }
      renderCV();            // update chips for the agent you're on
      setStatus("Refreshed", true);
    }catch{
      setStatus("Could not refresh current values.", false);
    }
  }

  // Init
  (async function init(){
    for (let i=1;i<=AGENT_COUNT;i++){ working[i]={}; current[i]={}; }
    if (!locationId) return;

    setLoading("Loading current values…");
    await refreshFromServer();
    switchAgent(1);
  })();
</script>
</body>
</html>
