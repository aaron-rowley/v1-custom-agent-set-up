<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36; --orange:#ed6c03; --red:#ef4444; --green:#10b981; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }

  /* Top toolbar */
  .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .sop{ background:var(--red); color:#000; font-weight:800; border:none; text-decoration:none; padding:8px 12px; border-radius:12px; box-shadow:0 6px 14px rgba(239,68,68,.35); }
  .sop:hover{ filter:brightness(1.05); }
  .xbtn{ background:transparent; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer; }

  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }

  /* Sticky tabs + top actions */
  .tabs-wrap{ position:sticky; top:0; z-index:20; padding:10px 0 8px; background:linear-gradient(var(--bg), rgba(15,17,21,.92)); backdrop-filter: blur(2px); border-bottom:1px solid var(--line); }
  .tabsbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--line); padding:10px 14px; border-radius:999px; background:#0e1117; cursor:pointer; font-weight:700; font-size:13px; color:#cfd6e4; transition:.15s; }
  .tab:hover{ border-color:#3a404a; }
  .tab.active{ background:var(--orange); color:#000; border-color:var(--orange); box-shadow:0 6px 16px rgba(237,108,3,.35); }

  .top-actions{ display:flex; align-items:center; gap:10px; }
  .top-actions.hidden{ display:none; }
  .btn-sm{ background:var(--orange); color:#000; border:0; padding:10px 16px; border-radius:12px; font-weight:800; font-size:13px; cursor:pointer; }
  .btn-sm.secondary{ background:transparent; border:1px solid var(--line); color:#fff; }
  .dirty-dot{ width:8px; height:8px; border-radius:99px; background:var(--orange); box-shadow:0 0 0 4px rgba(237,108,3,.25); display:none; }
  .top-actions.dirty .dirty-dot{ display:inline-block; }

  /* Editing bar */
  .editing{ display:flex; align-items:center; gap:10px; margin:10px 0 12px; flex-wrap:wrap; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; background:rgba(237,108,3,.14); color:#ffd9b8; border:1px solid rgba(237,108,3,.45); }
  .copy-note{ font-size:12px; color:#a7f3d0; }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }
  .label-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{ width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }

  /* Rows */
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .row-follow{ display:grid; grid-template-columns:1fr auto 1fr; gap:14px; align-items:end; }

  /* Token inserter */
  .ti{ display:flex; gap:8px; align-items:center; margin:6px 0 8px; }
  .ti select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .ti button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Helper pop-up */
  .ibtn{ background:transparent; border:1px dashed var(--line); color:#cfd6e4; font-size:12px; padding:4px 10px; border-radius:999px; cursor:pointer; }
  .tip{ position:fixed; max-width:320px; background:#0b0f14; border:1px solid #273042; border-radius:10px; padding:10px 12px; z-index:10001; box-shadow:0 16px 48px rgba(0,0,0,.5); }
  .tip.hidden{ display:none; }

  /* Current value chip */
  .cv{ margin-top:6px; font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #2a2f37; background:#0f141a; display:inline-block; }
  .cv strong{ font-weight:800; }
  .cv.has-value{ border-color:rgba(16,185,129,.55); background:rgba(16,185,129,.10); color:#a7f3d0; }
  .cv.empty{ border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.10); color:#fecaca; }

  .divider{ height:1px; background:var(--line); margin:30px 0; opacity:.8; }

  /* Segmented control (follow ups) */
  .seg{ display:flex; gap:6px; background:#0e1117; border:1px solid var(--line); border-radius:999px; padding:4px; }
  .segbtn{ background:transparent; border:none; color:#cfd6e4; font-weight:800; padding:8px 12px; border-radius:999px; cursor:pointer; }
  .segbtn.seg-on{ background:var(--orange); color:#000; box-shadow:0 6px 14px rgba(237,108,3,.35); }

  /* Overlay loader */
  .overlay{ position:fixed; inset:0; background:rgba(15,17,21,.72); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .overlay.hidden{ display:none; }
  .loading{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .bigspin{ width:46px; height:46px; border:5px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:999px; animation:spin .9s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Examples modal (scrollable) */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10000; }
  .modal.show{ display:flex; }
  .modal-card{ width:min(820px, 92vw); background:#0f141a; border:1px solid #273042; border-radius:16px; padding:16px; box-shadow:0 16px 48px rgba(0,0,0,.5); max-height:80vh; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .modal-title{ font-weight:800; }
  .ex-list{ display:flex; flex-direction:column; gap:14px; max-height:65vh; overflow:auto; padding-right:6px; }
  .ex-group{ border:1px solid #263142; border-radius:12px; padding:10px; background:#0b0f14; }
  .ex-group h4{ margin:0 0 8px; font-size:13px; color:#a7b0c0; letter-spacing:.2px; }
  .ex-item{ border:1px solid #263142; border-radius:10px; padding:10px; background:#0f141a; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .ex-text{ white-space:pre-wrap; color:#dbe2f0; font-size:14px; line-height:1.35; }
  .usebtn{ background:var(--green); color:#052; font-weight:800; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }

  /* Webhook response (pretty) */
  .resp{ margin-top:14px; }
  .resp.hidden{ display:none; }
  .resp-card{ border:1px solid #263142; background:#0b0f14; border-radius:14px; padding:14px; }
  .resp-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; font-weight:800; }
  .ok{ background:rgba(16,185,129,.15); color:#a7f3d0; border:1px solid rgba(16,185,129,.45); }
  .bad{ background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.45); }
  .resp-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  .kvt{ border:1px solid #273042; border-radius:10px; padding:10px; background:#0f141a; }
  .kvt h5{ margin:0 0 8px; font-size:12px; color:#a7b0c0; letter-spacing:.2px; }
  .kv{ display:grid; grid-template-columns:200px 1fr; gap:8px; font-size:13px; }
  .rawtoggle{ background:transparent; border:1px dashed #2b2f36; color:#cfd6e4; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px; }
  .rawbox{ margin-top:8px; display:none; }
  .rawbox pre{ background:#090d12; border:1px solid #263142; border-radius:12px; padding:12px; overflow:auto; max-height:260px; }

  .actions{ display:none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="sop" href="https://airtable.com/appZY3R7wWCzEsIZT/pagMdmBUMsAVRNYMe?ZHpwB=recPcFlbdOVjRopk2" target="_blank" rel="noopener">Link to SOP</a>
      <button class="xbtn" id="refreshBtn" title="Reload widget">Refresh</button>
    </div>

    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <!-- Sticky tabs + actions -->
    <div class="tabs-wrap">
      <div class="tabsbar">
        <div class="tabs" id="tabs"></div>
        <div class="top-actions hidden" id="topActions">
          <span class="dirty-dot" title="Unsaved changes"></span>
          <button class="btn-sm" id="submitBtnTop">Save</button>
          <button class="btn-sm secondary" id="saveNextBtnTop">Save & Next</button>
        </div>
      </div>
    </div>

    <div class="editing">
      <span class="sub">Editing:</span>
      <span class="chip" id="agentChip">Custom campaign agent 1</span>
      <button class="xbtn" id="copyPrevBtn" title="Copy current values from previous agent">Copy prev</button>
      <span class="copy-note" id="copyNote"></span>
      <span class="sub" id="status" style="margin-left:auto;"></span>
    </div>

    <div class="card" id="formCard">
      <!-- Active -->
      <div class="label-row"><label>Active? ("Yes" or leave blank)</label></div>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv empty" id="cv_active"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Campaign name -->
      <div class="label-row"><label>Campaign name</label></div>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv empty" id="cv_campaign"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Per day + Followups + Cadence -->
      <div class="row-follow">
        <!-- Per-day -->
        <div>
          <div class="label-row">
            <label>How many per day</label>
            <button class="ibtn" data-tip="How many contacts per day we will send to between 8am and 8pm, Monday to Saturday.">What’s this?</button>
          </div>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>100</option><option>150</option><option>200</option><option>250</option>
            <option>300</option><option>350</option><option>500</option>
          </select>
          <div class="cv empty" id="cv_perday"><strong>Current value:</strong> (not set)</div>
        </div>

        <!-- Follow-ups (segmented) -->
        <div>
          <div class="label-row">
            <label>Number of follow ups</label>
            <button class="ibtn" data-tip="How many follow-up bumps after the IM (initial message) to schedule.">What’s this?</button>
          </div>
          <div id="followupsSeg" class="seg" role="tablist" aria-label="Number of follow ups">
            <button type="button" class="segbtn" data-n="0" aria-selected="false">0</button>
            <button type="button" class="segbtn" data-n="1" aria-selected="false">1</button>
            <button type="button" class="segbtn" data-n="2" aria-selected="false">2</button>
            <button type="button" class="segbtn seg-on" data-n="3" aria-selected="true">3</button>
          </div>
          <div class="cv empty" id="cv_followups"><strong>Current value:</strong> (not set)</div>
        </div>

        <!-- Cadence -->
        <div>
          <div class="label-row">
            <label>Follow up cadence</label>
            <button class="ibtn" data-tip="IM = Initial message (the very first outbound). The numbers are delays between follow-ups (e.g. ‘IM > 24h > 48h > 72h’). Display shows the first N delays based on follow-ups; saving always uses the FULL cadence string.">What’s this?</button>
          </div>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv empty" id="cv_cadence"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- First message -->
      <div class="label-row">
        <label>First message</label>
        <button class="ibtn" data-tip="This is the first outbound message of the campaign (IM). Keep it short and human.">What’s this?</button>
        <button class="xbtn ex-btn" data-target="firstMessage" data-kind="first">Examples</button>
      </div>
      <div class="ti" data-target="firstMessage">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="firstMessage" class="big" placeholder="Type the first message…"></textarea>
      <div class="cv empty" id="cv_firstmsg"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 1 -->
      <div class="label-row">
        <label>Bump 1</label>
        <button class="ibtn" data-tip="Short nudge after IM based on the cadence above. Aim to confirm we’ve got the right number and keep the door open.">What’s this?</button>
        <button class="xbtn ex-btn" data-target="bump1" data-kind="bump1">Examples</button>
      </div>
      <div class="ti" data-target="bump1">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump1" class="big" placeholder="Bump 1…"></textarea>
      <div class="cv empty" id="cv_bump1"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 2 -->
      <div class="label-row">
        <label>Bump 2</label>
        <button class="ibtn" data-tip="Second follow-up. Keep it polite and low-friction; ask for a simple confirmation or preference.">What’s this?</button>
        <button class="xbtn ex-btn" data-target="bump2" data-kind="bump2">Examples</button>
      </div>
      <div class="ti" data-target="bump2">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump2" class="big" placeholder="Bump 2…"></textarea>
      <div class="cv empty" id="cv_bump2"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 3 -->
      <div class="label-row">
        <label>Bump 3</label>
        <button class="ibtn" data-tip="Final follow-up. Close the loop, be helpful, offer a next step (call, test drive, or ‘I’ll keep an eye out’).">What’s this?</button>
        <button class="xbtn ex-btn" data-target="bump3" data-kind="bump3">Examples</button>
      </div>
      <div class="ti" data-target="bump3">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump3" class="big" placeholder="Bump 3…"></textarea>
      <div class="cv empty" id="cv_bump3"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Notes -->
      <div class="label-row">
        <label>Notes about campaign</label>
        <button class="xbtn ex-btn" data-target="notes" data-kind="notes">Examples</button>
      </div>
      <div class="ti" data-target="notes">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="notes" class="big" placeholder="Write notes/prompts here…"></textarea>
      <div class="cv empty" id="cv_notes"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Webhook response -->
      <div class="resp hidden" id="respBox">
        <div class="label-row"><label>Webhook response</label></div>
        <div class="resp-card">
          <div class="resp-head">
            <div id="respStatusPill" class="pill ok">200 OK</div>
            <button class="rawtoggle" id="rawToggle">View raw JSON</button>
          </div>
          <div class="resp-grid" id="respGrid"></div>
          <div class="rawbox" id="rawBox"><pre id="rawPre"></pre></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay loader -->
  <div id="overlay" class="overlay hidden" aria-live="polite" aria-busy="true">
    <div class="loading"><div class="bigspin"></div><div id="overlayText">Loading…</div></div>
  </div>

  <!-- Floating helper tooltip -->
  <div id="tooltip" class="tip hidden" role="dialog" aria-live="polite"></div>

  <!-- Examples modal -->
  <div id="exModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="exTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="exTitle">Examples</div>
        <button class="xbtn" id="exClose">Close</button>
      </div>
      <div class="ex-list" id="exList"></div>
    </div>
  </div>

<script>
  /* ------------------- URL CONFIG ------------------- */
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";

  const RAW_FETCH_URL   = decodeURIComponent(get("fetchUrl")  || "");
  const RAW_SUBMIT_URL  = decodeURIComponent(get("submitUrl") || "");
  const AUTH_HEADER = get("authHeader") || "";
  const AUTH_TOKEN  = get("authToken")  || "";
  const APIKEY_HEADER = get("apiKeyHeader") || "";
  const APIKEY_VALUE  = get("apiKey")      || "";
  const PROXY = decodeURIComponent(get("proxy") || ""); // optional proxy

  // Final URLs (optionally via proxy)
  const FETCH_URL  = PROXY ? `${PROXY}?url=${encodeURIComponent(RAW_FETCH_URL)}`  : RAW_FETCH_URL;
  const SUBMIT_URL = PROXY ? `${PROXY}?url=${encodeURIComponent(RAW_SUBMIT_URL)}` : RAW_SUBMIT_URL;

  const AGENTS = 5;

  function buildHeaders(){
    const h = { "Content-Type":"application/json" };
    if (AUTH_HEADER && AUTH_TOKEN) h[AUTH_HEADER] = AUTH_TOKEN;
    if (APIKEY_HEADER && APIKEY_VALUE) h[APIKEY_HEADER] = APIKEY_VALUE;
    return h;
  }
  /* -------------------------------------------------- */

  // Examples (same as before)
  const EXAMPLES = {
    first: [
      { group: "Simple & human", items: [
        "Hey {{contact.first_name}}, it’s {{location.name}}. Still shopping or did you already find something you like?",
        "Hi {{contact.first_name}}, quick follow-up from {{location.name}} — want me to text a few good options that fit what you told us?",
        "{{contact.first_name}}, this is {{location.name}}. If you share budget and style, I’ll send 2–3 solid picks you can actually see this week.",
        "Hey {{contact.first_name}} — did you still want to come by for a quick look? I can hold a time if that helps."
      ] }
    ],
    bump1: [
      { group: "Light touch", items: [
        "Just checking I’ve got the right person — is this {{contact.first_name}}?",
        "Hey {{contact.first_name}}, quick confirm this is the best number to reach you?"
      ]},
      { group: "Friendly", items: [
        "Hi {{contact.first_name}}! Did I catch you on the right line here?",
        "{{contact.first_name}} — is this you? I’ve got a couple vehicles you might like."
      ]}
    ],
    bump2: [
      { group: "Polite nudge", items: [
        "Mind confirming this is still your number, {{contact.first_name}}?",
        "Is it okay if I text a couple options here, {{contact.first_name}}?"
      ]},
      { group: "Direct", items: [
        "Still good to text you on this line, {{contact.first_name}}?",
        "Can I send availability for a quick visit, {{contact.first_name}}?"
      ]}
    ],
    bump3: [
      { group: "Close the loop", items: [
        "Circling back, {{contact.first_name}} — want me to lock a quick time to pop in?",
        "If you’ve moved on, no worries at all. Want me to keep an eye out for matches and text you when one hits?"
      ]},
      { group: "Helpful", items: [
        "Happy to set a quick call with a specialist if that’s easier.",
        "Want me to book a test-drive slot for you, {{contact.first_name}}?"
      ]}
    ],
    notes: [
      { group: "Fresh Up Follow Up", items: [`
Fresh Up Follow Up

Most recent agent: "Fresh Up Follow Up".
Customer visited showroom ~10 days ago. Objective: invite back & rebook.

1) Re-introduce briefly (skip WFH assistant bit here).
2) Ask how their search is going; acknowledge what they say.
3) Move into qualified prospect questions + any booking criteria.
Best path is to schedule a call with a specialist to walk final steps.
One question at a time per interaction.`]},
      { group: "Service to Sales (Appraisal)", items: [`
Service to Sales (Appraisal)

Most recent agent: "Service to Sales (Appraisal)".
Customer recently scheduled service; invite them to get an appraisal (online or phone).

1) Re-introduce. Ask how the vehicle is doing (use model only if available).
2) Acknowledge; then ask if they'd like an appraisal.
3) If online: send link www.juneksbuysusedcars.com and ask them to ping when submitted so you can raise it with the team.
4) When done: say "Great, thanks. A buying specialist will contact you soon to discuss the next steps".
5) If phone: offer a call with a specialist and use that trigger phrase in your sign-off.`]},
      { group: "Phone Up Follow Up", items: [`
Phone Up Follow Up

Most recent agent: "Fresh Up Follow Up".
Customer phoned dealership ~7 days ago. Objective: invite to visit & set appointment.

1) Re-introduce; quick "how's the search going?"
2) Acknowledge; then standard qualified prospect flow + booking criteria.
3) Suggest a call with a specialist if helpful. One question at a time.`]},
      { group: "Internet Up Follow Up", items: [`
Internet Up Follow Up

Most recent agent: "Fresh Up Follow Up".
Brand-new internet lead. Objective: invite to set an appointment in-store.

1) Re-introduce; quick "how's the search going?"
2) Acknowledge; then qualified prospect + booking criteria.
3) Offer to line up a call or test drive. One question at a time.`]}
    ]
  };

  const locationId   = get("locationId");
  const businessName = get("businessName");

  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const showOverlay = (t="Loading…") => { overlayText.textContent=t; overlay.classList.remove("hidden"); };
  const hideOverlay = () => overlay.classList.add("hidden");

  // Pretty webhook display elements
  const respBox   = document.getElementById("respBox");
  const respGrid  = document.getElementById("respGrid");
  const rawBox    = document.getElementById("rawBox");
  const rawPre    = document.getElementById("rawPre");
  const rawToggle = document.getElementById("rawToggle");
  const respStatusPill = document.getElementById("respStatusPill");
  rawToggle.addEventListener("click", ()=>{
    rawBox.style.display = rawBox.style.display === "block" ? "none" : "block";
    rawToggle.textContent = rawBox.style.display === "block" ? "Hide raw JSON" : "View raw JSON";
  });

  function showWebhookResponse(body, meta = {}) {
    const ok = (meta.status ?? 200) >= 200 && (meta.status ?? 200) < 300;
    respStatusPill.className = "pill " + (ok ? "ok" : "bad");
    respStatusPill.textContent = (meta.status ? `${meta.status}` : "200") + (ok ? " OK" : " Error");

    respGrid.innerHTML = "";
    let blocks = [];
    if (Array.isArray(body) && body[0]?.data) blocks = body[0].data;
    else if (Array.isArray(body?.data)) blocks = body.data;

    if (Array.isArray(blocks) && blocks.length) {
      const group = document.createElement("div");
      group.className = "kvt";
      const h = document.createElement("h5"); h.textContent = "Saved fields";
      group.appendChild(h);

      blocks.slice(0, 100).forEach(item=>{
        const box = document.createElement("div");
        box.className = "kv";
        const pairs = [
          ["Custom value name", item["Custom value name"]],
          ["Field key", item["Custom value field key"]],
          ["Value", item["Custom value - Value"]],
          ["Custom value ID", item["Custom value ID"]],
          ["Trace", item["GHL Trace ID"]],
        ];
        pairs.forEach(([k,v])=>{
          if (v===undefined || v===null) return;
          const kEl=document.createElement("div"); kEl.style.color="#a7b0c0"; kEl.textContent=k;
          const vEl=document.createElement("div"); vEl.textContent=String(v);
          box.appendChild(kEl); box.appendChild(vEl);
        });
        group.appendChild(box);
      });
      respGrid.appendChild(group);
    } else {
      const g = document.createElement("div");
      g.className="kvt";
      const h=document.createElement("h5"); h.textContent="Response";
      const p=document.createElement("div"); p.className="kv";
      p.innerHTML = `<div style="color:#a7b0c0">Message</div><div>${typeof body==='string'? body : 'Complete'}</div>`;
      g.appendChild(h); g.appendChild(p);
      respGrid.appendChild(g);
    }

    rawPre.textContent = JSON.stringify(body, null, 2);
    respBox.classList.remove("hidden");
  }

  // Header
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  document.getElementById("refreshBtn").addEventListener("click", ()=> location.reload());

  // Tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENTS;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Agent ${i}`;
    t.dataset.agent = i;
    t.setAttribute("aria-selected", i===1 ? "true" : "false");
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const agentChip    = document.getElementById("agentChip");
  const copyPrevBtn  = document.getElementById("copyPrevBtn");
  const copyNote     = document.getElementById("copyNote");

  const toggle       = document.getElementById("activeToggle");
  const activeLabel  = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");

  const perDay       = document.getElementById("perDay");
  const cadence      = document.getElementById("cadence");
  const followupsSeg = document.getElementById("followupsSeg");

  const firstMessage = document.getElementById("firstMessage");
  const bump1        = document.getElementById("bump1");
  const bump2        = document.getElementById("bump2");
  const bump3        = document.getElementById("bump3");
  const notes        = document.getElementById("notes");
  const statusEl     = document.getElementById("status");

  // Sticky top actions
  const topActions   = document.getElementById("topActions");
  const submitBtnTop = document.getElementById("submitBtnTop");
  const saveNextBtnTop = document.getElementById("saveNextBtnTop");

  const cv = {
    active:   document.getElementById("cv_active"),
    campaign: document.getElementById("cv_campaign"),
    perday:   document.getElementById("cv_perday"),
    followups:document.getElementById("cv_followups"),
    cadence:  document.getElementById("cv_cadence"),
    firstmsg: document.getElementById("cv_firstmsg"),
    bump1:    document.getElementById("cv_bump1"),
    bump2:    document.getElementById("cv_bump2"),
    bump3:    document.getElementById("cv_bump3"),
    notes:    document.getElementById("cv_notes"),
  };

  // Working/current snapshots
  const working = {};
  const current = {};
  let agent = 1;

  // Defaults for bumps
  const BUMP1_DEFAULT = "Hopefully I have the right number — is this {{contact.first_name}}?";
  const BUMP2_DEFAULT = "Just making sure I’ve got the right person — is this {{contact.first_name}}?";
  const BUMP3_DEFAULT = "Just circling back {{contact.first_name}}. Need any help from us at {{location.name}}?";

  /* ---------- Cadence preview + per-day cap ---------- */
  const PERDAY_FULL = [10,25,50,75,100,150,200,250,300,350,500];

  function ensureCadenceValues(){
    [...cadence.options].forEach(opt=>{
      const full = opt.textContent.trim();
      opt.value = full;            // save the full string
      opt.dataset.full = full;     // keep original text
    });
  }

  function previewCadence(full, n){
    const parts = full.split(">").map(s=>s.trim()).filter(Boolean);
    const head = parts.slice(0, Math.min(n+1, parts.length)).join(" > ");
    const tail = parts.slice(n+1);
    return tail.length ? `${head} · ${tail.join(" > ")}` : head;
  }

  function applyCadencePreview(n){
    [...cadence.options].forEach(opt=>{
      const full = opt.dataset.full || opt.value || opt.textContent.trim();
      opt.textContent = previewCadence(full, n);
    });
  }

  function restrictPerDay(n){
    let max = 500;
    if (n===1) max=250;
    else if (n===2) max=200;
    else if (n>=3) max=150;
    const cur = Number(perDay.value) || 100;
    const allowed = PERDAY_FULL.filter(v=>v<=max);
    perDay.innerHTML = "";
    allowed.forEach(v=>{
      const o=document.createElement("option");
      o.value=String(v); o.textContent=String(v);
      perDay.appendChild(o);
    });
    const target = allowed.includes(cur) ? cur : Math.max(...allowed);
    perDay.value = String(target);
  }

  // Follow-ups segmented control
  let followups = 3;
  function setFollowups(n){
    followups = Math.max(0, Math.min(3, Number(n)||0));
    [...followupsSeg.querySelectorAll('.segbtn')].forEach(b=>{
      const on = Number(b.dataset.n)===followups;
      b.classList.toggle('seg-on', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });
    setCV(cv.followups, followups);
    applyCadencePreview(followups);
    restrictPerDay(followups);
    recalcSaveVisibility();
  }
  followupsSeg.addEventListener('click', e=>{
    const btn = e.target.closest('.segbtn');
    if (!btn) return;
    setFollowups(Number(btn.dataset.n));
  });

  // Toggle behavior
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
    recalcSaveVisibility();
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token inserter
  function insertTokenInto(el, token){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    const cur   = el.value || "";
    el.value = cur.slice(0,start) + token + cur.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
    recalcSaveVisibility();
  }
  document.querySelectorAll(".ti").forEach(ti=>{
    const target = document.getElementById(ti.dataset.target);
    const sel = ti.querySelector("select");
    const btn = ti.querySelector("button");
    btn.addEventListener("click", ()=> insertTokenInto(target, sel.value));
  });

  // Helper pop-ups
  const tip = document.getElementById("tooltip");
  function showTip(btn){
    const text = btn.getAttribute("data-tip") || "";
    if (!text) return;
    tip.textContent = text;
    const r = btn.getBoundingClientRect();
    tip.style.left = Math.min(window.innerWidth - 340, r.left) + "px";
    tip.style.top  = (r.bottom + 8) + "px";
    tip.classList.remove("hidden");
  }
  function hideTip(){ tip.classList.add("hidden"); }
  document.addEventListener("click", (e)=>{
    if (e.target.classList.contains("ibtn")) { showTip(e.target); }
    else if (!tip.classList.contains("hidden")) { hideTip(); }
  });

  // Inputs listeners
  [campaignName, perDay, cadence, firstMessage, bump1, bump2, bump3, notes].forEach(el=>{
    el.addEventListener("input", recalcSaveVisibility);
    el.addEventListener("change", recalcSaveVisibility);
  });

  function setStatus(text, ok){
    statusEl.textContent = text || "";
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setCV(el, value){
    const has = value !== undefined && value !== null && String(value).trim() !== "";
    el.innerHTML = `<strong>Current value:</strong> ${has ? String(value) : "(not set)"}`;
    el.classList.toggle("has-value", has);
    el.classList.toggle("empty", !has);
  }

  // Keys for agent (override via key_*_N)
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:    base + "active_yes_or_leave_blank",
      campaign:  base + "campaign_name",
      perday:    base + "how_many_per_day_see_sop",
      followups: base + "number_of_follow_ups",
      cadence:   base + "follow_up_cadence",
      firstmsg:  base + "first_message",
      bump1:     base + "bump_1",
      bump2:     base + "bump_2",
      bump3:     base + "bump_3",
      notes:     base + "notes_about_campaign"
    };
  }
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`);
      if (q) map[field] = q;
    }
    return map;
  }

  function renderCV(){
    setCV(cv.active,     current[agent]?.active);
    setCV(cv.campaign,   current[agent]?.campaign);
    setCV(cv.perday,     current[agent]?.perday);
    setCV(cv.followups,  current[agent]?.followups);
    setCV(cv.cadence,    current[agent]?.cadence);
    setCV(cv.firstmsg,   current[agent]?.firstmsg);
    setCV(cv.bump1,      current[agent]?.bump1);
    setCV(cv.bump2,      current[agent]?.bump2);
    setCV(cv.bump3,      current[agent]?.bump3);
    setCV(cv.notes,      current[agent]?.notes);
  }

  function switchAgent(n){
    working[agent] = getFormValues();

    [...tabsEl.children].forEach(btn=>{
      const is = Number(btn.dataset.agent)===n;
      btn.classList.toggle("active", is);
      btn.setAttribute('aria-selected', is ? 'true' : 'false');
    });

    agent = n;
    agentChip.textContent = `Custom campaign agent ${agent}`;
    document.title = `Agent ${agent} • Custom agent set up`;

    copyPrevBtn.style.display = agent === 1 ? "none" : "inline-flex";
    copyNote.textContent = "";

    const w = working[agent] || {};
    const prevIndex = agent === 1 ? AGENTS : agent - 1;
    const curA = current[agent] || {};
    const prevA = current[prevIndex] || {};

    // prepare cadence options once
    ensureCadenceValues();

    // Follow-ups first (affects cadence preview & per-day list)
    const fuSeed = Number(w.followups ?? curA.followups ?? prevA.followups ?? 3);
    setFollowups(fuSeed);

    campaignName.value = w.campaign || curA.campaign || prevA.campaign || "";
    perDay.value       = String(w.perday   || curA.perday   || prevA.perday || perDay.value);
    cadence.value      = w.cadence  || curA.cadence  || prevA.cadence  || cadence.value;
    firstMessage.value = w.firstmsg || curA.firstmsg || prevA.firstmsg || "";
    bump1.value        = w.bump1    || curA.bump1    || prevA.bump1    || BUMP1_DEFAULT;
    bump2.value        = w.bump2    || curA.bump2    || prevA.bump2    || BUMP2_DEFAULT;
    bump3.value        = w.bump3    || curA.bump3    || prevA.bump3    || BUMP3_DEFAULT;
    notes.value        = w.notes    || curA.notes    || prevA.notes    || "";

    const activeSeed = (w.active || curA.active || prevA.active || "");
    setActive( activeSeed.toLowerCase()==="yes" );

    renderCV();
    recalcSaveVisibility();
    setStatus("");
    respBox.classList.add("hidden");
  }

  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      perday:   perDay.value,
      followups: String(followups),
      cadence:  cadence.value,             // full string (value)
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.value
    };
  }

  function isBlankTextFields(){
    const v = getFormValues();
    const emptyActive = v.active==="";
    const emptyTexts =
      !v.campaign &&
      !v.firstmsg &&
      (!v.bump1 || v.bump1.trim()===BUMP1_DEFAULT) &&
      (!v.bump2 || v.bump2.trim()===BUMP2_DEFAULT) &&
      (!v.bump3 || v.bump3.trim()===BUMP3_DEFAULT) &&
      !v.notes;
    return emptyActive && emptyTexts;
  }

  function diffData(n, { ignoreDefaults=false } = {}){
    const now = getFormValues();
    const cur = current[n] || {};
    const labels = {
      active:   `Custom campaign agent ${n} – Active`,
      campaign: `Custom campaign agent ${n} – Campaign name`,
      perday:   `Custom campaign agent ${n} – How many per day`,
      followups:`Custom campaign agent ${n} – Number of follow ups`,
      cadence:  `Custom campaign agent ${n} – Follow up cadence`,
      firstmsg: `Custom campaign agent ${n} – First message`,
      bump1:    `Custom campaign agent ${n} – Bump 1`,
      bump2:    `Custom campaign agent ${n} – Bump 2`,
      bump3:    `Custom campaign agent ${n} – Bump 3`,
      notes:    `Custom campaign agent ${n} – Notes about campaign`
    };

    const changed = {};
    for (const k of Object.keys(labels)){
      let after = now[k] ?? "";
      const before = cur[k] ?? "";
      if (ignoreDefaults){
        if (k==="bump1" && after.trim()===BUMP1_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump2" && after.trim()===BUMP2_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump3" && after.trim()===BUMP3_DEFAULT.trim() && !before.trim()) continue;
      }
      if (String(before) !== String(after)) changed[ labels[k] ] = after;
    }
    return changed;
  }

  function recalcSaveVisibility(){
    const noChanges = Object.keys(diffData(agent, { ignoreDefaults:true })).length===0;
    const allEmpty  = isBlankTextFields();
    const show = !(noChanges || allEmpty);
    topActions.classList.toggle("hidden", !show);
    topActions.classList.toggle("dirty", show);
  }

  /* ---------------- SAVE HANDLER ---------------- */
  function parseMaybeJSON(t){ try{ return t ? JSON.parse(t) : {}; } catch{ return { raw:t }; } }

  async function saveAgentThenRefresh(agentNum, { jumpToNext } = {}){
    const changed = diffData(agentNum, { ignoreDefaults:false });
    if (!Object.keys(changed).length){ setStatus("No changes to save.", true); return; }

    const keysFull = overrideKeysFromQuery(cvKeys(agentNum), agentNum);
    const rev = {
      [`Custom campaign agent ${agentNum} – Active`]               : "active",
      [`Custom campaign agent ${agentNum} – Campaign name`]        : "campaign",
      [`Custom campaign agent ${agentNum} – How many per day`]     : "perday",
      [`Custom campaign agent ${agentNum} – Number of follow ups`] : "followups",
      [`Custom campaign agent ${agentNum} – Follow up cadence`]    : "cadence",
      [`Custom campaign agent ${agentNum} – First message`]        : "firstmsg",
      [`Custom campaign agent ${agentNum} – Bump 1`]               : "bump1",
      [`Custom campaign agent ${agentNum} – Bump 2`]               : "bump2",
      [`Custom campaign agent ${agentNum} – Bump 3`]               : "bump3",
      [`Custom campaign agent ${agentNum} – Notes about campaign`] : "notes"
    };
    const keysSubset = {};
    for (const label of Object.keys(changed)){
      const k = rev[label]; if (k) keysSubset[k] = keysFull[k];
    }

    const payload = { locationId, businessName, agent: agentNum, keys: keysSubset, data: changed };

    submitBtnTop.disabled = true;
    saveNextBtnTop.disabled = true;
    showOverlay("Saving…");

    try{
      const res = await fetch(SUBMIT_URL, {
        method:"POST",
        mode:"cors",
        cache:"no-store",
        credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify(payload)
      });

      const status  = res.status;
      const headers = Object.fromEntries([...res.headers.entries()]);
      const text    = await res.text();
      const parsed  = parseMaybeJSON(text);

      hideOverlay();
      setStatus(res.ok ? "Saved" : `Save returned ${status}`, res.ok);
      showWebhookResponse(parsed, { status, headers });

      // immediately refresh so chips reflect server
      await refreshFromServer();

      if (jumpToNext){
        const next = agentNum === AGENTS ? 1 : agentNum + 1;
        switchAgent(next);
      }
    } catch (err){
      hideOverlay();
      const tip = (String(err).includes("Failed to fetch"))
        ? "Likely CORS/preflight blocked by the API. Ask the API to allow Origin: " + location.origin + " and headers: Authorization, Content-Type."
        : "";
      setStatus("Network error. Try again.", false);
      showWebhookResponse({ error: String(err), hint: tip, submitUrl: SUBMIT_URL, origin: location.origin, headers: buildHeaders() }, { status: 0 });
    } finally {
      submitBtnTop.disabled = false;
      saveNextBtnTop.disabled = false;
      recalcSaveVisibility();
    }
  }

  submitBtnTop.addEventListener("click", (e)=>{
    e.preventDefault();
    if (!locationId || !SUBMIT_URL) return;
    saveAgentThenRefresh(agent, { jumpToNext:false });
  });
  saveNextBtnTop.addEventListener("click", (e)=>{
    e.preventDefault();
    if (!locationId || !SUBMIT_URL) return;
    saveAgentThenRefresh(agent, { jumpToNext:true });
  });
  /* -------------- END SAVE HANDLER --------------- */

  async function refreshFromServer(){
    if (!locationId) return;
    if (!FETCH_URL){ setStatus("Missing fetchUrl in query string.", false); return; }
    showOverlay("Refreshing…");
    const urlWithBust = FETCH_URL + (FETCH_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    try{
      const res = await fetch(urlWithBust, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify({ locationId })
      });
      const text = await res.text();
      let json; try { json = text ? JSON.parse(text) : {}; } catch { json = {}; }
      const agents = json?.agents || {};
      for (let i=1;i<=AGENTS;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? "",
          campaign: a.campaign ?? "",
          perday:   a.perday ?? "",
          followups:a.followups ?? a.number_of_follow_ups ?? "",
          cadence:  a.cadence ?? "",
          firstmsg: a.firstmsg ?? "",
          bump1:    a.bump1 ?? "",
          bump2:    a.bump2 ?? "",
          bump3:    a.bump3 ?? "",
          notes:    a.notes ?? ""
        };
      }
      renderCV();
      recalcSaveVisibility();
      setStatus("Refreshed", true);
    }catch(err){
      const tip = (String(err).includes("Failed to fetch"))
        ? "Likely CORS/preflight blocked by the API. Ask the API to allow Origin: " + location.origin + " and headers: Authorization, Content-Type."
        : "";
      setStatus("Could not refresh current values.", false);
      showWebhookResponse({ error: String(err), hint: tip, fetchUrl: FETCH_URL, origin: location.origin, headers: buildHeaders() }, { status: 0 });
    }finally{
      hideOverlay();
    }
  }

  copyPrevBtn.addEventListener("click", ()=>{
    const prev = agent === 1 ? AGENTS : agent - 1;
    const src = current[prev] || {};
    setActive((src.active || "").toLowerCase()==="yes");
    setFollowups(Number(src.followups ?? 3));
    campaignName.value = src.campaign || "";
    perDay.value       = src.perday   || perDay.value;
    cadence.value      = src.cadence  || cadence.value;
    firstMessage.value = src.firstmsg || "";
    bump1.value        = src.bump1    || BUMP1_DEFAULT;
    bump2.value        = src.bump2    || BUMP2_DEFAULT;
    bump3.value        = src.bump3    || BUMP3_DEFAULT;
    notes.value        = src.notes    || "";
    copyNote.textContent = `Copied values from Agent ${prev}.`;
    setTimeout(()=> copyNote.textContent="", 3500);
    recalcSaveVisibility();
  });

  // Examples modal logic
  const exModal = document.getElementById("exModal");
  const exList  = document.getElementById("exList");
  const exClose = document.getElementById("exClose");
  document.querySelectorAll(".ex-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const kind = btn.dataset.kind;       // first | bump1 | bump2 | bump3 | notes
      const targetId = btn.dataset.target; // textarea id
      const groups = EXAMPLES[kind] || [];
      exList.innerHTML = "";
      document.getElementById("exTitle").textContent = `Examples — ${kind.replace(/^./,c=>c.toUpperCase())}`;
      groups.forEach(g=>{
        const block = document.createElement("div");
        block.className = "ex-group";
        const h = document.createElement("h4"); h.textContent = g.group;
        block.appendChild(h);
        (g.items||[]).forEach(txt=>{
          const row = document.createElement("div");
          row.className = "ex-item";
          const p = document.createElement("div");
          p.className = "ex-text";
          p.textContent = txt.trim();
          const use = document.createElement("button");
          use.className = "usebtn";
          use.textContent = "Use";
          use.onclick = () => {
            const field = document.getElementById(targetId);
            field.value = txt.trim();
            exModal.classList.remove("show");
            field.focus();
            recalcSaveVisibility();
          };
          row.appendChild(p); row.appendChild(use);
          block.appendChild(row);
        });
        exList.appendChild(block);
      });
      exModal.classList.add("show");
    });
  });
  exClose.addEventListener("click", ()=> exModal.classList.remove("show"));
  exModal.addEventListener("click", (e)=>{ if (e.target===exModal) exModal.classList.remove("show"); });

  (async function init(){
    // normalize cadence option values for full-string saving
    ensureCadenceValues();

    for (let i=1;i<=AGENTS;i++){ working[i]={}; current[i]={}; }
    if (!locationId){ setStatus("Missing locationId", false); return; }
    showOverlay("Loading current values…");
    await refreshFromServer();  // hides overlay
    switchAgent(1);
  })();
</script>
</body>
</html>
