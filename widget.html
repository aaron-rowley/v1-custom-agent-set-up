<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36; --orange:#ed6c03; --red:#ef4444; --green:#10b981; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }

  /* Top toolbar */
  .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .sop{ background:var(--red); color:#000; font-weight:800; border:none; text-decoration:none; padding:8px 12px; border-radius:12px; box-shadow:0 6px 14px rgba(239,68,68,.35); }
  .sop:hover{ filter:brightness(1.05); }
  .xbtn{ background:transparent; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer; }

  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }

  /* Sticky tabs + top actions */
  .tabs-wrap{ position:sticky; top:0; z-index:20; padding:10px 0 8px; background:linear-gradient(var(--bg), rgba(15,17,21,.92)); backdrop-filter: blur(2px); border-bottom:1px solid var(--line); }
  .tabsbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--line); padding:10px 14px; border-radius:999px; background:#0e1117; cursor:pointer; font-weight:700; font-size:13px; color:#cfd6e4; transition:.15s; }
  .tab:hover{ border-color:#3a404a; }
  .tab.active{ background:var(--orange); color:#000; border-color:var(--orange); box-shadow:0 6px 16px rgba(237,108,3,.35); }

  .top-actions{ display:flex; align-items:center; gap:10px; }
  .top-actions.hidden{ display:none; }
  .btn-sm{ background:var(--orange); color:#000; border:0; padding:10px 16px; border-radius:12px; font-weight:800; font-size:13px; cursor:pointer; }
  .btn-sm.secondary{ background:transparent; border:1px solid var(--line); color:#fff; }
  .dirty-dot{ width:8px; height:8px; border-radius:99px; background:var(--orange); box-shadow:0 0 0 4px rgba(237,108,3,.25); display:none; }
  .top-actions.dirty .dirty-dot{ display:inline-block; }

  /* Editing bar */
  .editing{ display:flex; align-items:center; gap:10px; margin:10px 0 12px; flex-wrap:wrap; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; background:rgba(237,108,3,.14); color:#ffd9b8; border:1px solid rgba(237,108,3,.45); }
  .copy-note{ font-size:12px; color:#a7f3d0; }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }
  .label-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{ width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }

  /* Rows */
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .row-follow{ display:grid; grid-template-columns:1fr auto 1fr; gap:14px; align-items:end; }

  /* Token inserter */
  .ti{ display:flex; gap:8px; align-items:center; margin:6px 0 8px; }
  .ti select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .ti button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Helper pop-up */
  .ibtn{ background:transparent; border:1px dashed var(--line); color:#cfd6e4; font-size:12px; padding:4px 10px; border-radius:999px; cursor:pointer; }
  .tip{ position:fixed; max-width:320px; background:#0b0f14; border:1px solid #273042; border-radius:10px; padding:10px 12px; z-index:10001; box-shadow:0 16px 48px rgba(0,0,0,.5); }
  .tip.hidden{ display:none; }

  /* Current value chip */
  .cv{ margin-top:6px; font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #2a2f37; background:#0f141a; display:inline-block; }
  .cv strong{ font-weight:800; }
  .cv.has-value{ border-color:rgba(16,185,129,.55); background:rgba(16,185,129,.10); color:#a7f3d0; }
  .cv.empty{ border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.10); color:#fecaca; }

  .divider{ height:1px; background:var(--line); margin:30px 0; opacity:.8; }

  /* Segmented control (follow ups) */
  .seg{ display:flex; gap:6px; background:#0e1117; border:1px solid var(--line); border-radius:999px; padding:4px; }
  .segbtn{ background:transparent; border:none; color:#cfd6e4; font-weight:800; padding:8px 12px; border-radius:999px; cursor:pointer; }
  .segbtn.seg-on{ background:var(--orange); color:#000; box-shadow:0 6px 14px rgba(237,108,3,.35); }

  /* Hide helper */
  .hidden{ display:none !important; }

  /* Overlay loader */
  .overlay{ position:fixed; inset:0; background:rgba(15,17,21,.72); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .overlay.hidden{ display:none; }
  .loading{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .bigspin{ width:46px; height:46px; border:5px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:999px; animation:spin .9s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Examples modal (scrollable) */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10000; }
  .modal.show{ display:flex; }
  .modal-card{ width:min(820px, 92vw); background:#0f141a; border:1px solid #273042; border-radius:16px; padding:16px; box-shadow:0 16px 48px rgba(0,0,0,.5); max-height:80vh; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .modal-title{ font-weight:800; }
  .ex-list{ display:flex; flex-direction:column; gap:14px; max-height:65vh; overflow:auto; padding-right:6px; }
  .ex-group{ border:1px solid #263142; border-radius:12px; padding:10px; background:#0b0f14; }
  .ex-group h4{ margin:0 0 8px; font-size:13px; color:#a7b0c0; letter-spacing:.2px; }
  .ex-item{ border:1px solid #263142; border-radius:10px; padding:10px; background:#0f141a; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .ex-text{ white-space:pre-wrap; color:#dbe2f0; font-size:14px; line-height:1.35; }
  .usebtn{ background:var(--green); color:#052; font-weight:800; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }

  /* Webhook response (pretty) */
  .resp{ margin-top:14px; }
  .resp.hidden{ display:none; }
  .resp-card{ border:1px solid #263142; background:#0b0f14; border-radius:14px; padding:14px; }
  .resp-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; font-weight:800; }
  .ok{ background:rgba(16,185,129,.15); color:#a7f3d0; border:1px solid rgba(16,185,129,.45); }
  .bad{ background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.45); }
  .resp-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  .kvt{ border:1px solid #273042; border-radius:10px; padding:10px; background:#0f141a; }
  .kvt h5{ margin:0 0 8px; font-size:12px; color:#a7b0c0; letter-spacing:.2px; }
  .kv{ display:grid; grid-template-columns:200px 1fr; gap:8px; font-size:13px; }
  .rawtoggle{ background:transparent; border:1px dashed #2b2f36; color:#cfd6e4; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px; }
  .rawbox{ margin-top:8px; display:none; }
  .rawbox pre{ background:#090d12; border:1px solid #263142; border-radius:12px; padding:12px; overflow:auto; max-height:260px; }

  .actions{ display:none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="sop" href="https://airtable.com/appZY3R7wWCzEsIZT/pagMdmBUMsAVRNYMe?ZHpwB=recPcFlbdOVjRopk2" target="_blank" rel="noopener">Link to SOP</a>
      <button class="xbtn" id="refreshBtn" title="Reload widget">Refresh</button>
    </div>

    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <!-- Sticky tabs + actions -->
    <div class="tabs-wrap">
      <div class="tabsbar">
        <div class="tabs" id="tabs"></div>
        <div class="top-actions hidden" id="topActions">
          <span class="dirty-dot" title="Unsaved changes"></span>
          <button class="btn-sm" id="submitBtnTop">Save</button>
          <button class="btn-sm secondary" id="saveNextBtnTop">Save & Next</button>
        </div>
      </div>
    </div>

    <div class="editing">
      <span class="sub">Editing:</span>
      <span class="chip" id="agentChip">Custom campaign agent 1</span>
      <button class="xbtn" id="copyPrevBtn" title="Copy current values from previous agent">Copy prev</button>
      <span class="copy-note" id="copyNote"></span>
      <span class="sub" id="status" style="margin-left:auto;"></span>
    </div>

    <div class="card" id="formCard">
      <!-- Active -->
      <div class="label-row"><label>Active? ("Yes" or leave blank)</label></div>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv empty" id="cv_active"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Campaign name -->
      <div class="label-row"><label>Campaign name</label></div>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv empty" id="cv_campaign"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Per day + Followups + Cadence -->
      <div class="row-follow">
        <!-- Per-day -->
        <div>
          <div class="label-row">
            <label>How many per day</label>
            <button class="ibtn" data-tip="How many contacts per day we will send to between 8am and 8pm, Monday to Saturday.">What’s this?</button>
          </div>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>100</option><option>150</option><option>200</option><option>250</option>
            <option>300</option><option>350</option><option>500</option>
          </select>
          <div class="cv empty" id="cv_perday"><strong>Current value:</strong> (not set)</div>
        </div>

        <!-- Follow-ups (segmented) -->
        <div>
          <div class="label-row">
            <label>Number of follow ups</label>
            <button class="ibtn" data-tip="How many follow-up bumps after the IM (initial message) to schedule.">What’s this?</button>
          </div>
          <div id="followupsSeg" class="seg" role="tablist" aria-label="Number of follow ups">
            <button type="button" class="segbtn" data-n="0" aria-selected="false">0</button>
            <button type="button" class="segbtn" data-n="1" aria-selected="false">1</button>
            <button type="button" class="segbtn" data-n="2" aria-selected="false">2</button>
            <button type="button" class="segbtn seg-on" data-n="3" aria-selected="true">3</button>
          </div>
          <div class="cv empty" id="cv_followups"><strong>Current value:</strong> (not set)</div>
        </div>

        <!-- Cadence -->
        <div>
          <div class="label-row">
            <label>Follow up cadence</label>
            <button class="ibtn" data-tip="IM = Initial message (the very first outbound). The numbers are delays between follow-ups (e.g. ‘IM > 24h > 48h > 72h’). Display shows only what will send based on # of follow-ups; saving always uses the FULL cadence string.">What’s this?</button>
          </div>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv empty" id="cv_cadence"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- First message -->
      <div class="label-row">
        <label>First message</label>
        <button class="ibtn" data-tip="This is the first outbound message of the campaign (IM). Keep it short and human.">What’s this?</button>
        <button class="xbtn ex-btn" data-target="firstMessage" data-kind="first">Examples</button>
      </div>
      <div class="ti" data-target="firstMessage">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="[Type business name here]">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="firstMessage" class="big" placeholder="Type the first message…"></textarea>
      <div class="cv empty" id="cv_firstmsg"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bumps (each wrapped so we can hide/show by follow-ups) -->
      <div class="bump-block" data-b="1">
        <div class="label-row">
          <label>Bump 1</label>
          <button class="ibtn" data-tip="Short nudge after IM based on the cadence above. Aim to confirm we’ve got the right number and keep the door open.">What’s this?</button>
          <button class="xbtn ex-btn" data-target="bump1" data-kind="bump1">Examples</button>
        </div>
        <div class="ti" data-target="bump1">
          <select>
            <option value="{{contact.first_name}}">First name</option>
            <option value="{{contact.last_name}}">Last name</option>
            <option value="{{contact.full_name}}">Full name</option>
            <option value="{{contact.email}}">Email</option>
            <option value="{{contact.phone}}">Phone</option>
            <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
            <option value="{{contact.make}}">Make</option>
            <option value="{{contact.model}}">Model</option>
            <option value="[Type business name here]">Business name</option>
          </select>
          <button type="button">Insert</button>
        </div>
        <textarea id="bump1" class="big" placeholder="Bump 1…"></textarea>
        <div class="cv empty" id="cv_bump1"><strong>Current value:</strong> (not set)</div>
        <div class="divider"></div>
      </div>

      <div class="bump-block" data-b="2">
        <div class="label-row">
          <label>Bump 2</label>
          <button class="ibtn" data-tip="Second follow-up. Keep it polite and low-friction; ask for a simple confirmation or preference.">What’s this?</button>
          <button class="xbtn ex-btn" data-target="bump2" data-kind="bump2">Examples</button>
        </div>
        <div class="ti" data-target="bump2">
          <select>
            <option value="{{contact.first_name}}">First name</option>
            <option value="{{contact.last_name}}">Last name</option>
            <option value="{{contact.full_name}}">Full name</option>
            <option value="{{contact.email}}">Email</option>
            <option value="{{contact.phone}}">Phone</option>
            <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
            <option value="{{contact.make}}">Make</option>
            <option value="{{contact.model}}">Model</option>
            <option value="[Type business name here]">Business name</option>
          </select>
          <button type="button">Insert</button>
        </div>
        <textarea id="bump2" class="big" placeholder="Bump 2…"></textarea>
        <div class="cv empty" id="cv_bump2"><strong>Current value:</strong> (not set)</div>
        <div class="divider"></div>
      </div>

      <div class="bump-block" data-b="3">
        <div class="label-row">
          <label>Bump 3</label>
          <button class="ibtn" data-tip="Final follow-up. Close the loop, be helpful, offer a next step (call, test drive, or ‘I’ll keep an eye out’).">What’s this?</button>
          <button class="xbtn ex-btn" data-target="bump3" data-kind="bump3">Examples</button>
        </div>
        <div class="ti" data-target="bump3">
          <select>
            <option value="{{contact.first_name}}">First name</option>
            <option value="{{contact.last_name}}">Last name</option>
            <option value="{{contact.full_name}}">Full name</option>
            <option value="{{contact.email}}">Email</option>
            <option value="{{contact.phone}}">Phone</option>
            <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
            <option value="{{contact.make}}">Make</option>
            <option value="{{contact.model}}">Model</option>
            <option value="[Type business name here]">Business name</option>
          </select>
          <button type="button">Insert</button>
        </div>
        <textarea id="bump3" class="big" placeholder="Bump 3…"></textarea>
        <div class="cv empty" id="cv_bump3"><strong>Current value:</strong> (not set)</div>
        <div class="divider"></div>
      </div>

      <!-- Notes -->
      <div class="label-row">
        <label>Notes about campaign</label>
        <button class="xbtn ex-btn" data-target="notes" data-kind="notes">Examples</button>
      </div>
      <div class="ti" data-target="notes">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="[Type business name here]">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="notes" class="big" placeholder="Write notes/prompts here…"></textarea>
      <div class="cv empty" id="cv_notes"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Webhook response -->
      <div class="resp hidden" id="respBox">
        <div class="label-row"><label>Webhook response</label></div>
        <div class="resp-card">
          <div class="resp-head">
            <div id="respStatusPill" class="pill ok">200 OK</div>
            <button class="rawtoggle" id="rawToggle">View raw JSON</button>
          </div>
          <div class="resp-grid" id="respGrid"></div>
          <div class="rawbox" id="rawBox"><pre id="rawPre"></pre></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay loader -->
  <div id="overlay" class="overlay hidden" aria-live="polite" aria-busy="true">
    <div class="loading"><div class="bigspin"></div><div id="overlayText">Loading…</div></div>
  </div>

  <!-- Floating helper tooltip -->
  <div id="tooltip" class="tip hidden" role="dialog" aria-live="polite"></div>

  <!-- Examples modal -->
  <div id="exModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="exTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="exTitle">Examples</div>
        <button class="xbtn" id="exClose">Close</button>
      </div>
      <div class="ex-list" id="exList"></div>
    </div>
  </div>

<script>
  /* ------------------- URL CONFIG ------------------- */
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";

  function getUrlMaybeEncoded(param){
    const v = get(param) || "";
    return /%[0-9A-Fa-f]{2}/.test(v) ? decodeURIComponent(v) : v;
  }

  const FETCH_URL      = getUrlMaybeEncoded("fetchUrl");
  const SUBMIT_URL     = getUrlMaybeEncoded("submitUrl");
  const AUTH_HEADER    = get("authHeader") || "";
  const AUTH_TOKEN     = get("authToken")  || "";
  const APIKEY_HEADER  = get("apiKeyHeader") || "";
  const APIKEY_VALUE   = get("apiKey") || "";
  const AGENTS = 5;

  const locationId   = get("locationId");
  const businessName = get("businessName");

  // optional per-field prefills (from loader: data-value-*)
  const seedVals = {
    active:   get("val_active"),
    bump1:    get("val_bump1"),
    bump2:    get("val_bump2"),
    bump3:    get("val_bump3"),
    campaign: get("val_campaign"),
    firstmsg: get("val_firstmsg"),
    cadence:  get("val_cadence"),
    perday:   get("val_perday"),
    notes:    get("val_notes"),
  };

  function buildHeaders(){
    const h = { "Content-Type":"application/json" };
    if (AUTH_HEADER && AUTH_TOKEN) h[AUTH_HEADER] = AUTH_TOKEN;
    if (APIKEY_HEADER && APIKEY_VALUE) h[APIKEY_HEADER] = APIKEY_VALUE;
    return h;
  }

  /* ------------------- EXAMPLES DATA ------------------- */
  // Helper: replace {{location.name}} / agent placeholders in any legacy strings if needed
  const swapPlaceholders = s =>
    s.replaceAll("{{location.name}}","[Type business name here]")
     .replaceAll("{{location.name}}","[Type business name here]")
     .replaceAll("{{agent.first_name}}","[Type Agent name here]")
     .replaceAll("{{agent.name}}","[Type Agent name here]")
     .replaceAll("{{agent}}","[Type Agent name here]");

  const EXAMPLES = {
    /* FIRST MESSAGE — aligned to Set-node wording */
    first: [
      {
        title: "DBR — IM",
        items: [
          "Hey its [Agent Name] from [business name]. Is this the same {{contact.first_name}} who was looking for a vehicle recently?"
        ]
      },
      {
        title: "Service to Sales (Appraisal) — IM",
        items: [
          "Hi {{contact.first_name}}, it’s [Type Agent name here] from [Type business name here] — how are you and your {{contact.model}} doing?"
        ]
      },
      {
        title: "Phone Up Follow Up — IM",
        items: [
          "Hey {{contact.first_name}}, how are you? It’s [Type Agent name here] from [Type business name here]. I had a quick note to check in—how’s the vehicle search going?"
        ]
      },
      {
        title: "Internet Up Follow Up — IM",
        items: [
          "Hi {{contact.first_name}}, it’s [Type Agent name here] with [Type business name here]. I saw your online request—how’s the vehicle search going?"
        ]
      }
    ],
    /* BUMPS — keep concise; one question per interaction */
    bump1: [
      { title: "Fresh Up Follow Up — Bump 1", items: [
        "Quick nudge — want me to hold a 10-minute slot this week to revisit top picks?"
      ]},
      { title: "Service to Sales (Appraisal) — Bump 1", items: [
        "Open to a quick appraisal? I can send a link for online or have a buying specialist call — which do you prefer?"
      ]},
      { title: "Phone Up Follow Up — Bump 1", items: [
        "Shall I pencil you in for a quick walkthrough? Morning or afternoon?"
      ]},
      { title: "Internet Up Follow Up — Bump 1", items: [
        "Prefer a 10-minute call or a quick visit to look at options?"
      ]}
    ],
    bump2: [
      { title: "Fresh Up Follow Up — Bump 2", items: [
        "If nothing grabbed you yet, I can text 2–3 matches and hold one. Want me to do that?"
      ]},
      { title: "Service to Sales (Appraisal) — Bump 2", items: [
        "Online works great — I’ll send the link now. When you submit, I’ll bring it up to the team. Want the link?"
      ]},
      { title: "Phone Up Follow Up — Bump 2", items: [
        "I can have a specialist ready when you pop in. Would a quick 15-minute slot help?"
      ]},
      { title: "Internet Up Follow Up — Bump 2", items: [
        "I’ve got availability to show you options — would after-work today or tomorrow be better?"
      ]}
    ],
    bump3: [
      { title: "Fresh Up Follow Up — Bump 3", items: [
        "Last check-in from [Type business name here] — want me to keep looking or should I close this out for now?"
      ]},
      { title: "Service to Sales (Appraisal) — Bump 3", items: [
        "No rush on the appraisal. I can send the link and a buying specialist will contact you soon to discuss the next steps. Want me to send it?"
      ]},
      { title: "Phone Up Follow Up — Bump 3", items: [
        "Happy to close the loop here. Would you like me to hold a time this weekend just in case?"
      ]},
      { title: "Internet Up Follow Up — Bump 3", items: [
        "If timing isn’t right, I can keep an eye out and text you when a perfect match hits — sound good?"
      ]}
    ],
    /* NOTES / PROMPTS — exact Campaign Objectives from Set nodes (each has its own Use button) */
    notes: [
      {
        title: "DBR — Campaign Objective",
        sop: [
`=If the chat history indicates that the most recent agent to be activated is the “dbr” Agent - we are doing a general reach out to see if {{contact.first_name}} has purchased a vehicle yet.

1.0 – If their first response is positive, acknowledge the response (without a greeting) and say:  
“{{contact.first_initial_response_message}}”

Then on a new paragraph:  
“Just wanted to see if you're still on the lookout for a vehicle or if you are still looking at your options?”

1.1 – If the response to the message asking who they are or one of the follow up messages is not positive (for example “no” or “no it isn’t” or “wrong number”), then apologize say:

“My apologies, looks like there’s a mix-up – I'll make sure you don't get any more messages.  Before you go, is anyone you know looking to buy or sell a vehicle at this time? :)”

Then if they say no to that question, say  
“no worries, have a great day, take care”
 2.0 - If their response to the question about exploring vehicle options is negative, go to 2.1 - If is positive, go to 2.2. 
2.1 – Acknowledge the response and try to figure out what is holding them back from moving forward. Utilize your training to pry a little and move toward qualification without sounding too pushy. The only exception is if they say they already bought a vehicle. In which case move onto the “already purchased” protocol.

2.2 – Acknowledge the response and then begin to converse with the customer about their vehicle needs and what we can do to help. 

Make sure to ask 2 relevant qualification questions in regular conversation, qualifying them & finding out we can help without offering any advice or answering questions about price or inventory before going for the appointment/call. 
3.0 - When you have asked your questions, ask if they would like to chat with the relevant person from the department you think will help them best & then move onto the sales booking protocol.

One question at a time per interaction.`
        ]
      },
      {
        title: "Service to Sales (Appraisal) — Campaign Objective",
        sop: [
`=If the chat history indicates that the most recent agent to be activated is the "Service to Sales (Appraisal)" Agent,

This means we are reaching out to a customer who scheduled a service appointment very recently & the objective is to invite them to have their vehicle appraised either online or get the process started over the phone with a specialist.

1.0 – We will be (re) introducing ourselves and asking how their vehicle is. (We are skipping the assistant working from home message here in this convo.) This will be a short "Hi [their name], it’s [your name] from [dealership name] — how are you and your [vehicle but without the year, just the model; if nothing available, use 'vehicle'] doing?" message.

2.0 – Once they tell us how they / their vehicle is we want to acknowledge what they say empathetically,

and then on a new line say:

"I just wanted to quickly check-in, see how you were and also quickly ask if you were interested in getting your [vehicle] appraised?"

2.1 – If they say yes, ask if they would like to do it online or if they would like to have an appraisal specialist reach out to them.

3.1 – If they say online, send them this link: www.juneksbuysusedcars.com and say "Once you start, could you let me know when you’ve submitted your info? That way, I’ll bring it up to the team."

3.1.1 – Once they are done, say "Great, thanks. A buying specialist will contact you soon to discuss the next steps" and then wish them a nice day (don’t use "take care" or "have a wonderful day" here as the phrase "buying specialist will contact you soon to discuss the next steps" is the trigger phrase tool that will send to the buying team so make sure you use it when appropriate).

If they say over the phone, use the "buying specialist" trigger phrase tool in your sign-off message as you are just in admin.

Note: One question at a time per interaction.`
        ]
      },
      {
        title: "Phone Up Follow Up — Campaign Objective",
        sop: [
`=If the chat history indicates that the most recent agent to be activated is the "Fresh Up Follow Up" Agent,

This means we are reaching out to customers who called the dealership 7 days ago & the conversation objective is to invite them to visit the store and set an appointment.

1.0 – We will be (re) introducing ourselves and asking how their vehicle search is. (Skipping the assistant working from home message.) Short "Hey [their name], how are you? It’s [your name] from [dealership name]. I had a quick note here to reach out, how is the vehicle search going?" message.

2.0 – After they reply, acknowledge empathetically and continue with default qualified prospect section and any booking criteria.

The best way to book is to schedule a call with a specialist who will walk them through any final things.

One question at a time per interaction.`
        ]
      },
      {
        title: "Internet Up Follow Up — Campaign Objective",
        sop: [
`=If the chat history indicates that the most recent agent to be activated is the "Fresh Up Follow Up" Agent,

This means we are reaching out to a customer who is a brand new internet lead & the conversation objective is to invite them to set an appointment in our store.

1.0 – (Re) introduce and ask how their vehicle search is. (Skipping the assistant working from home message.) Short "Hey [their name], how are you? It’s [your name] from [dealership name]. I had a quick note here to reach out, how is the vehicle search going?" message.

2.0 – Once they reply, acknowledge empathetically and continue with the default qualified prospect section and any booking criteria.

The best way to book is to schedule a call with a specialist who will walk them through any final things.

One question at a time per interaction.`
        ]
      }
    ]
  };

  /* ------------------- WEBHOOK UI HELPERS ------------------- */
  const respBox   = document.getElementById("respBox");
  const respGrid  = document.getElementById("respGrid");
  const rawBox    = document.getElementById("rawBox");
  const rawPre    = document.getElementById("rawPre");
  const rawToggle = document.getElementById("rawToggle");
  const respStatusPill = document.getElementById("respStatusPill");
  rawToggle.addEventListener("click", ()=>{
    rawBox.style.display = rawBox.style.display === "block" ? "none" : "block";
    rawToggle.textContent = rawBox.style.display === "block" ? "Hide raw JSON" : "View raw JSON";
  });

  function showWebhookResponse(body, meta = {}) {
    const ok = (meta.status ?? 200) >= 200 && (meta.status ?? 200) < 300;
    respStatusPill.className = "pill " + (ok ? "ok" : "bad");
    respStatusPill.textContent = (meta.status ? `${meta.status}` : "200") + (ok ? " OK" : " Error");

    respGrid.innerHTML = "";
    let blocks = [];
    if (Array.isArray(body) && body[0]?.data) blocks = body[0].data;
    else if (Array.isArray(body?.data)) blocks = body.data;

    if (Array.isArray(blocks) && blocks.length) {
      const group = document.createElement("div");
      group.className = "kvt";
      const h = document.createElement("h5"); h.textContent = "Saved fields";
      group.appendChild(h);

      blocks.slice(0, 100).forEach(item=>{
        const box = document.createElement("div");
        box.className = "kv";
        const pairs = [
          ["Custom value name", item["Custom value name"]],
          ["Field key", item["Custom value field key"]],
          ["Value", item["Custom value - Value"]],
          ["Custom value ID", item["Custom value ID"]],
          ["Trace", item["GHL Trace ID"]],
        ];
        pairs.forEach(([k,v])=>{
          if (v===undefined || v===null) return;
          const kEl=document.createElement("div"); kEl.style.color="#a7b0c0"; kEl.textContent=k;
          const vEl=document.createElement("div"); vEl.textContent=String(v);
          box.appendChild(kEl); box.appendChild(vEl);
        });
        group.appendChild(box);
      });
      respGrid.appendChild(group);
    } else {
      const g = document.createElement("div");
      g.className="kvt";
      const h=document.createElement("h5"); h.textContent="Response";
      const p=document.createElement("div"); p.className="kv";
      p.innerHTML = `<div style="color:#a7b0c0">Message</div><div>${typeof body==='string'? body : 'Complete'}</div>`;
      g.appendChild(h); g.appendChild(p);
      respGrid.appendChild(g);
    }

    rawPre.textContent = JSON.stringify(body, null, 2);
    respBox.classList.remove("hidden");
  }

  // Header text
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  document.getElementById("refreshBtn").addEventListener("click", ()=> location.reload());

  // Tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENTS;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Agent ${i}`;
    t.dataset.agent = i;
    t.setAttribute("aria-selected", i===1 ? "true" : "false");
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const agentChip    = document.getElementById("agentChip");
  const copyPrevBtn  = document.getElementById("copyPrevBtn");
  const copyNote     = document.getElementById("copyNote");

  const toggle       = document.getElementById("activeToggle");
  const activeLabel  = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");

  const perDay       = document.getElementById("perDay");
  const cadence      = document.getElementById("cadence");
  const followupsSeg = document.getElementById("followupsSeg");

  const firstMessage = document.getElementById("firstMessage");
  const bump1        = document.getElementById("bump1");
  const bump2        = document.getElementById("bump2");
  const bump3        = document.getElementById("bump3");
  const notes        = document.getElementById("notes");
  const statusEl     = document.getElementById("status");

  // Sticky top actions
  const topActions   = document.getElementById("topActions");
  const submitBtnTop = document.getElementById("submitBtnTop");
  const saveNextBtnTop = document.getElementById("saveNextBtnTop");

  const cv = {
    active:   document.getElementById("cv_active"),
    campaign: document.getElementById("cv_campaign"),
    perday:   document.getElementById("cv_perday"),
    followups:document.getElementById("cv_followups"),
    cadence:  document.getElementById("cv_cadence"),
    firstmsg: document.getElementById("cv_firstmsg"),
    bump1:    document.getElementById("cv_bump1"),
    bump2:    document.getElementById("cv_bump_2") || document.getElementById("cv_bump2"),
    bump3:    document.getElementById("cv_bump3"),
    notes:    document.getElementById("cv_notes"),
  };

  // Working/current snapshots
  const working = {};
  const current = {};
  let agent = 1;

  // Defaults for bumps
  const BUMP1_DEFAULT = "Hopefully I have the right number — is this {{contact.first_name}}?";
  const BUMP2_DEFAULT = "Just making sure I’ve got the right person — is this {{contact.first_name}}?";
  const BUMP3_DEFAULT = "Just circling back {{contact.first_name}}. Need any help from us at [Type business name here]?";

  /* ---------- Cadence preview + per-day cap ---------- */
  const PERDAY_FULL = [10,25,50,75,100,150,200,250,300,350,500];

  function ensureCadenceValues(){
    [...cadence.options].forEach(opt=>{
      const full = opt.textContent.trim();
      opt.value = full;
      opt.dataset.full = full;
    });
  }

  function previewCadence(full, n){
    const parts = full.split(">").map(s=>s.trim()).filter(Boolean);
    const head = parts.slice(0, Math.min(n+1, parts.length)).join(" > ");
    return head;
  }

  function applyCadencePreview(n){
    [...cadence.options].forEach(opt=>{
      const full = opt.dataset.full || opt.value || opt.textContent.trim();
      opt.textContent = previewCadence(full, n);
    });
  }

  function restrictPerDay(n){
    let max = 500;
    if (n===1) max=250;
    else if (n===2) max=200;
    else if (n>=3) max=150;
    const cur = Number(perDay.value) || 100;
    const allowed = PERDAY_FULL.filter(v=>v<=max);
    perDay.innerHTML = "";
    allowed.forEach(v=>{
      const o=document.createElement("option");
      o.value=String(v); o.textContent=String(v);
      perDay.appendChild(o);
    });
    const target = allowed.includes(cur) ? cur : Math.max(...allowed);
    perDay.value = String(target);
  }

  // Follow-ups segmented control + visibility
  let followups = 3;
  function updateBumpVisibility(){
    const blocks = document.querySelectorAll('.bump-block');
    blocks.forEach(b=>{
      const idx = Number(b.getAttribute('data-b'));
      b.classList.toggle('hidden', idx > followups);
    });
  }
  function setFollowups(n){
    followups = Math.max(0, Math.min(3, Number(n)||0));
    [...followupsSeg.querySelectorAll('.segbtn')].forEach(b=>{
      const on = Number(b.dataset.n)===followups;
      b.classList.toggle('seg-on', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });
    setCV(cv.followups, followups);
    applyCadencePreview(followups);
    restrictPerDay(followups);
    updateBumpVisibility();
    recalcSaveVisibility();
  }
  followupsSeg.addEventListener('click', e=>{
    const btn = e.target.closest('.segbtn');
    if (!btn) return;
    setFollowups(Number(btn.dataset.n));
  });

  // Toggle behavior
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
    recalcSaveVisibility();
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token inserter
  function insertTokenInto(el, token){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    const cur   = el.value || "";
    el.value = cur.slice(0,start) + token + cur.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
    recalcSaveVisibility();
  }
  document.querySelectorAll(".ti").forEach(ti=>{
    const target = document.getElementById(ti.dataset.target);
    const sel = ti.querySelector("select");
    const btn = ti.querySelector("button");
    btn.addEventListener("click", ()=> insertTokenInto(target, sel.value));
  });

  // Helper pop-ups
  const tip = document.getElementById("tooltip");
  function showTip(btn){
    const text = btn.getAttribute("data-tip") || "";
    if (!text) return;
    tip.textContent = text;
    const r = btn.getBoundingClientRect();
    tip.style.left = Math.min(window.innerWidth - 340, r.left) + "px";
    tip.style.top  = (r.bottom + 8) + "px";
    tip.classList.remove("hidden");
  }
  function hideTip(){ tip.classList.add("hidden"); }
  document.addEventListener("click", (e)=>{
    if (e.target.classList.contains("ibtn")) { showTip(e.target); }
    else if (!tip.classList.contains("hidden")) { hideTip(); }
  });

  // Inputs listeners
  [campaignName, perDay, cadence, firstMessage, bump1, bump2, bump3, notes].forEach(el=>{
    el.addEventListener("input", recalcSaveVisibility);
    el.addEventListener("change", recalcSaveVisibility);
  });

  function setStatus(text, ok){
    statusEl.textContent = text || "";
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setCV(el, value){
    const has = value !== undefined && value !== null && String(value).trim() !== "";
    el.innerHTML = `<strong>Current value:</strong> ${has ? String(value) : "(not set)"}`;
    el.classList.toggle("has-value", has);
    el.classList.toggle("empty", !has);
  }

  // Keys for agent (override via key_*_N)
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:    base + "active_yes_or_leave_blank",
      campaign:  base + "campaign_name",
      perday:    base + "how_many_per_day_see_sop",
      followups: base + "number_of_follow_ups",
      cadence:   base + "follow_up_cadence",
      firstmsg:  base + "first_message",
      bump1:     base + "bump_1",
      bump2:     base + "bump_2",
      bump3:     base + "bump_3",
      notes:     base + "notes_about_campaign"
    };
  }
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`) || qs.get(`key_${field}`); // allow generic or per-agent
      if (q) map[field] = q;
    }
    return map;
  }

  function renderCV(){
    setCV(cv.active,     current[agent]?.active);
    setCV(cv.campaign,   current[agent]?.campaign);
    setCV(cv.perday,     current[agent]?.perday);
    setCV(cv.followups,  current[agent]?.followups);
    setCV(cv.cadence,    current[agent]?.cadence);
    setCV(cv.firstmsg,   current[agent]?.firstmsg);
    setCV(cv.bump1,      current[agent]?.bump1);
    setCV(cv.bump2,      current[agent]?.bump2);
    setCV(cv.bump3,      current[agent]?.bump3);
    setCV(cv.notes,      current[agent]?.notes);
  }

  function switchAgent(n){
    working[agent] = getFormValues();

    [...tabsEl.children].forEach(btn=>{
      const is = Number(btn.dataset.agent)===n;
      btn.classList.toggle("active", is);
      btn.setAttribute('aria-selected', is ? 'true' : 'false');
    });

    agent = n;
    agentChip.textContent = `Custom campaign agent ${agent}`;
    document.title = `Agent ${agent} • Custom agent set up`;

    copyPrevBtn.style.display = agent === 1 ? "none" : "inline-flex";
    copyNote.textContent = "";

    const w = working[agent] || {};
    const prevIndex = agent === 1 ? AGENTS : agent - 1;
    const curA = current[agent] || {};
    const prevA = current[prevIndex] || {};

    ensureCadenceValues();

    // Follow-ups first
    const fuSeed = Number(
      w.followups ?? curA.followups ?? prevA.followups ?? seedVals.followups ?? 3
    );
    setFollowups(fuSeed);

    campaignName.value = w.campaign || curA.campaign || prevA.campaign || seedVals.campaign || "";
    perDay.value       = String(w.perday   || curA.perday   || prevA.perday || seedVals.perday || perDay.value);
    cadence.value      = w.cadence  || curA.cadence  || prevA.cadence  || seedVals.cadence || cadence.value;
    firstMessage.value = w.firstmsg || curA.firstmsg || prevA.firstmsg || seedVals.firstmsg || "";
    bump1.value        = w.bump1    || curA.bump1    || prevA.bump1    || seedVals.bump1    || BUMP1_DEFAULT;
    bump2.value        = w.bump2    || curA.bump2    || prevA.bump2    || seedVals.bump2    || BUMP2_DEFAULT;
    bump3.value        = w.bump3    || curA.bump3    || prevA.bump3    || seedVals.bump3    || BUMP3_DEFAULT;
    notes.value        = w.notes    || curA.notes    || prevA.notes    || seedVals.notes    || "";

    const activeSeed = (w.active || curA.active || prevA.active || seedVals.active || "");
    setActive( String(activeSeed).toLowerCase()==="yes" );

    renderCV();
    recalcSaveVisibility();
    setStatus("");
    respBox.classList.add("hidden");
  }

  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      perday:   perDay.value,
      followups: String(followups),
      cadence:  cadence.value,
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.value
    };
  }

  function isBlankTextFields(){
    const v = getFormValues();
    const emptyActive = v.active==="";
    const emptyTexts =
      !v.campaign &&
      !v.firstmsg &&
      (!v.bump1 || v.bump1.trim()===BUMP1_DEFAULT.trim()) &&
      (!v.bump2 || v.bump2.trim()===BUMP2_DEFAULT.trim()) &&
      (!v.bump3 || v.bump3.trim()===BUMP3_DEFAULT.trim()) &&
      !v.notes;
    return emptyActive && emptyTexts;
  }

  function diffData(n, { ignoreDefaults=false } = {}){
    const now = getFormValues();
    const cur = current[n] || {};
    const labels = {
      active:   `Custom campaign agent ${n} – Active`,
      campaign: `Custom campaign agent ${n} – Campaign name`,
      perday:   `Custom campaign agent ${n} – How many per day`,
      followups:`Custom campaign agent ${n} – Number of follow ups`,
      cadence:  `Custom campaign agent ${n} – Follow up cadence`,
      firstmsg: `Custom campaign agent ${n} – First message`,
      bump1:    `Custom campaign agent ${n} – Bump 1`,
      bump2:    `Custom campaign agent ${n} – Bump 2`,
      bump3:    `Custom campaign agent ${n} – Bump 3`,
      notes:    `Custom campaign agent ${n} – Notes about campaign`
    };

    const changed = {};
    for (const k of Object.keys(labels)){
      let after = now[k] ?? "";
      const before = cur[k] ?? "";
      if (ignoreDefaults){
        if (k==="bump1" && after.trim()===BUMP1_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump2" && after.trim()===BUMP2_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump3" && after.trim()===BUMP3_DEFAULT.trim() && !before.trim()) continue;
      }
      if (String(before) !== String(after)) changed[ labels[k] ] = after;
    }
    return changed;
  }

  function recalcSaveVisibility(){
    const noChanges = Object.keys(diffData(agent, { ignoreDefaults:true })).length===0;
    const allEmpty  = isBlankTextFields();
    const show = !(noChanges || allEmpty);
    topActions.classList.toggle("hidden", !show);
    topActions.classList.toggle("dirty", show);
  }

  /* ---------------- SAVE HANDLER ---------------- */
  function parseMaybeJSON(t){ try{ return t ? JSON.parse(t) : {}; } catch{ return { raw:t }; } }

  function ensureSubmitReady(){
    if (!locationId){
      setStatus("Missing locationId", false);
      return false;
    }
    if (!SUBMIT_URL){
      setStatus("Missing submitUrl in query string.", false);
      return false;
    }
    return true;
  }

  async function saveAgentThenRefresh(agentNum, { jumpToNext } = {}){
    if (!ensureSubmitReady()) return;

const vals     = getFormValues();
const keysFull = overrideKeysFromQuery(cvKeys(agentNum), agentNum);

// always submit the FULL cadence string (not the preview text)
const cadOpt   = document.getElementById("cadence").selectedOptions?.[0];
const fullCad  = (cadOpt?.dataset?.full) || vals.cadence;

const allData = {
  active:   vals.active,
  campaign: vals.campaign,
  perday:   vals.perday,
  followups: vals.followups,   // still send the chosen count
  cadence:  fullCad,           // full string e.g. "IM > 24h > 48h > 72h"
  firstmsg: vals.firstmsg,
  bump1:    vals.bump1,
  bump2:    vals.bump2,        // send even if hidden
  bump3:    vals.bump3,        // send even if hidden
  notes:    vals.notes
};

const payload = { locationId, businessName, agent: agentNum, keys: keysFull, data: allData };

    /* >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
       Replace all newlines with £%£% for GHL custom values
       <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< */
    for (const k in payload.data) {
      if (typeof payload.data[k] === "string") {
        payload.data[k] = payload.data[k].replace(/\r?\n/g, "£%£%");
      }
    }

    submitBtnTop.disabled = true;
    saveNextBtnTop.disabled = true;
    showOverlay("Saving…");

    try{
      const res = await fetch(SUBMIT_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify(payload)
      });

      const status  = res.status;
      const headers = Object.fromEntries([...res.headers.entries()]);
      const text    = await res.text();
      const parsed  = parseMaybeJSON(text);

      hideOverlay();
      setStatus(res.ok ? "Saved" : `Save returned ${status}`, res.ok);
      showWebhookResponse(parsed, { status, headers });

      // refresh current values if possible
      if (FETCH_URL){
        await refreshFromServer();
      }
      if (jumpToNext){
        const next = agentNum === AGENTS ? 1 : agentNum + 1;
        switchAgent(next);
      } else {
        renderCV();
        recalcSaveVisibility();
      }
    } catch (err){
      hideOverlay();
      setStatus("Network error. Try again.", false);
      showWebhookResponse({ error: String(err) }, { status: 0 });
    } finally {
      submitBtnTop.disabled = false;
      saveNextBtnTop.disabled = false;
    }
  }

  document.getElementById("submitBtnTop").addEventListener("click", (e)=>{
    e.preventDefault();
    saveAgentThenRefresh(agent, { jumpToNext:false });
  });
  document.getElementById("saveNextBtnTop").addEventListener("click", (e)=>{
    e.preventDefault();
    saveAgentThenRefresh(agent, { jumpToNext:true });
  });
  /* -------------- END SAVE HANDLER --------------- */

  async function refreshFromServer(){
    if (!locationId) return;
    if (!FETCH_URL){ setStatus("Missing fetchUrl in query string.", false); return; }
    showOverlay("Refreshing…");
    const urlWithBust = FETCH_URL + (FETCH_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    try{
      const res = await fetch(urlWithBust, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify({ locationId })
      });
      const text = await res.text();
      let json; try { json = text ? JSON.parse(text) : {}; } catch { json = {}; }

      const agents = json?.agents || {};
      for (let i=1;i<=AGENTS;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? seedVals.active ?? "",
          campaign: a.campaign ?? seedVals.campaign ?? "",
          perday:   a.perday ?? seedVals.perday ?? "",
          followups:a.followups ?? a.number_of_follow_ups ?? seedVals.followups ?? "",
          cadence:  a.cadence ?? seedVals.cadence ?? "",
          firstmsg: swapPlaceholders(a.firstmsg ?? seedVals.firstmsg ?? ""),
          bump1:    swapPlaceholders(a.bump1 ?? seedVals.bump1 ?? ""),
          bump2:    swapPlaceholders(a.bump2 ?? seedVals.bump2 ?? ""),
          bump3:    swapPlaceholders(a.bump3 ?? seedVals.bump3 ?? ""),
          notes:    swapPlaceholders(a.notes ?? seedVals.notes ?? "")
        };
      }
      renderCV();
      updateBumpVisibility();
      recalcSaveVisibility();
      setStatus("Refreshed", true);
    }catch{
      setStatus("Could not refresh current values.", false);
    }finally {
      hideOverlay();
    }
  }

  document.getElementById("copyPrevBtn").addEventListener("click", ()=>{
    const prev = agent === 1 ? AGENTS : agent - 1;
    const src = current[prev] || {};
    setActive((src.active || "").toLowerCase()==="yes");
    setFollowups(Number(src.followups ?? 3));
    campaignName.value = src.campaign || "";
    perDay.value       = src.perday   || perDay.value;
    cadence.value      = src.cadence  || cadence.value;
    firstMessage.value = src.firstmsg || "";
    bump1.value        = src.bump1    || BUMP1_DEFAULT;
    bump2.value        = src.bump2    || BUMP2_DEFAULT;
    bump3.value        = src.bump3    || BUMP3_DEFAULT;
    notes.value        = src.notes    || "";
    copyNote.textContent = `Copied values from Agent ${prev}.`;
    setTimeout(()=> copyNote.textContent="", 3500);
    recalcSaveVisibility();
  });

  function showOverlay(text){
    document.getElementById("overlayText").textContent = text || "Loading…";
    document.getElementById("overlay").classList.remove("hidden");
  }
  function hideOverlay(){
    document.getElementById("overlay").classList.add("hidden");
  }

  /* ------------------- EXAMPLES MODAL ------------------- */
  const exModal = document.getElementById("exModal");
  const exList  = document.getElementById("exList");
  const exClose = document.getElementById("exClose");
  let exTargetEl = null;

  function openExamples(kind, targetId){
    exTargetEl = document.getElementById(targetId);
    exList.innerHTML = "";
    const groups = EXAMPLES[kind] || [];

    groups.forEach(g=>{
      const group = document.createElement("div");
      group.className = "ex-group";

      const h = document.createElement("h4");
      h.textContent = g.title || "Examples";
      group.appendChild(h);

      // SOP / PROMPTS — now each line has its own Use button
      if (Array.isArray(g.sop) && g.sop.length){
        g.sop.forEach(line=>{
          const row = document.createElement("div");
          row.className = "ex-item";

          const txt = document.createElement("div");
          txt.className = "ex-text";
          txt.textContent = line;
          row.appendChild(txt);

          const btn = document.createElement("button");
          btn.className = "usebtn";
          btn.textContent = "Use";
          btn.addEventListener("click", ()=>{
            if (!exTargetEl) return;
            exTargetEl.value = line;
            exModal.classList.remove("show");
            exTargetEl.focus();
            recalcSaveVisibility();
          });
          row.appendChild(btn);

          group.appendChild(row);
        });
      }

      // TEMPLATE MESSAGES — each with its own Use button
      (g.items || []).forEach(text=>{
        const row = document.createElement("div");
        row.className = "ex-item";

        const txt = document.createElement("div");
        txt.className = "ex-text";
        txt.textContent = text;
        row.appendChild(txt);

        const btn = document.createElement("button");
        btn.className = "usebtn";
        btn.textContent = "Use";
        btn.addEventListener("click", ()=>{
          if (!exTargetEl) return;
          exTargetEl.value = text;
          exModal.classList.remove("show");
          exTargetEl.focus();
          recalcSaveVisibility();
        });
        row.appendChild(btn);

        group.appendChild(row);
      });

      exList.appendChild(group);
    });

    exModal.classList.add("show");
  }

  document.querySelectorAll(".ex-btn").forEach(b=>{
    b.addEventListener("click", ()=>{
      const target = b.getAttribute("data-target");
      const kind = b.getAttribute("data-kind");
      openExamples(kind, target);
    });
  });
  exClose.addEventListener("click", ()=> exModal.classList.remove("show"));
  exModal.addEventListener("click", (e)=>{ if (e.target===exModal) exModal.classList.remove("show"); });

  (async function init(){
    ensureCadenceValues();
    for (let i=1;i<=AGENTS;i++){ working[i]={}; current[i]={}; }
    if (!locationId){ setStatus("Missing locationId", false); return; }
    showOverlay("Loading current values…");
    if (FETCH_URL){
      await refreshFromServer();
    } else {
      for (let i=1;i<=AGENTS;i++){
        current[i] = {
          active:   seedVals.active ?? "",
          campaign: seedVals.campaign ?? "",
          perday:   seedVals.perday ?? "",
          followups: seedVals.followups ?? "3",
          cadence:  seedVals.cadence || "IM > 15m > 24h > 24h",
          firstmsg: swapPlaceholders(seedVals.firstmsg ?? ""),
          bump1:    swapPlaceholders(seedVals.bump1 || BUMP1_DEFAULT),
          bump2:    swapPlaceholders(seedVals.bump2 || BUMP2_DEFAULT),
          bump3:    swapPlaceholders(seedVals.bump3 || BUMP3_DEFAULT),
          notes:    swapPlaceholders(seedVals.notes ?? "")
        };
      }
      hideOverlay();
    }
    switchAgent(1);
    updateBumpVisibility();
  })();
</script>
</body>
</html>
