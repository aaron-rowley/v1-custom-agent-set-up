<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36; --orange:#ed6c03; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }
  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }
  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{
    width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
  }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .actions{ display:flex; align-items:center; gap:12px; margin-top:14px; }
  .btn{ background:var(--orange); color:#000; border:0; padding:10px 16px; border-radius:12px; font-weight:600; cursor:pointer; }
  .ghost{ background:transparent; color:#fff; border:1px solid var(--line); }
  .status{ font-size:13px; color:var(--muted); }

  /* Tabs */
  .tabs{ display:flex; gap:8px; margin:8px 0 14px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--line); padding:8px 12px; border-radius:999px; background:#0e1117; cursor:pointer; font-weight:600; }
  .tab.active{ background:rgba(237,108,3,.18); border-color:rgba(237,108,3,.45); }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Spinner */
  .spinner{ width:18px; height:18px; border:3px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:50%; animation:spin .9s linear infinite; display:inline-block; vertical-align:-3px; margin-right:6px; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Token inserter */
  .tokenbar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
  .tokenbar select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .tokenbar button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }
  .muted{ color:var(--muted); font-size:12px; }
  .cv{ margin-top:6px; font-size:12px; color:#9aa3b5; word-break:break-word; white-space:pre-wrap; }

  /* Prompt editor */
  .prompt{ background:#0e1117; border:1px solid var(--line); border-radius:14px; padding:10px; min-height:140px; }
  .prompt[contenteditable="true"]:empty:before{ content:attr(data-placeholder); color:var(--muted); }
  .toolbar{ display:flex; gap:8px; margin-bottom:8px; }
  .tb-btn{ background:#10151c; color:#fff; border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .small{ font-size:12px; color:#9aa3b5; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <!-- Tabs -->
    <div class="tabs" id="tabs"></div>

    <div class="card">
      <!-- Active toggle -->
      <label>Active? ("Yes" or leave blank)</label>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv" id="cv_active"></div>

      <!-- Campaign name -->
      <label>Campaign name</label>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv" id="cv_campaign"></div>

      <!-- Per day + Cadence -->
      <div class="row">
        <div>
          <label>How many per day (See SOP)</label>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>150</option><option>200</option><option>250</option><option>300</option>
            <option>350</option><option>500</option><option selected>100</option>
          </select>
          <div class="cv" id="cv_perday"></div>
        </div>
        <div>
          <label>Follow up cadence</label>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv" id="cv_cadence"></div>
        </div>
      </div>

      <!-- Token insert -->
      <div class="muted" style="margin-top:12px">Insert variable → appends into the focused text box.</div>
      <div class="tokenbar">
        <select id="tokenSelect">
          <option value="{{contact.first_name}}">{{contact.first_name}}</option>
          <option value="{{contact.last_name}}">{{contact.last_name}}</option>
          <option value="{{contact.full_name}}">{{contact.full_name}}</option>
          <option value="{{contact.email}}">{{contact.email}}</option>
          <option value="{{contact.phone}}">{{contact.phone}}</option>
          <option value="{{location.name}}">{{location.name}}</option>
        </select>
        <button type="button" id="insertToken">Insert</button>
      </div>

      <!-- Messages -->
      <label>First message</label>
      <textarea id="firstMessage" class="big" placeholder="Type the first message…"></textarea>
      <div class="cv" id="cv_firstmsg"></div>

      <label>Bump 1</label>
      <textarea id="bump1" class="big" placeholder="Bump 1…"></textarea>
      <div class="cv" id="cv_bump1"></div>

      <label>Bump 2</label>
      <textarea id="bump2" class="big" placeholder="Bump 2…"></textarea>
      <div class="cv" id="cv_bump2"></div>

      <label>Bump 3</label>
      <textarea id="bump3" class="big" placeholder="Bump 3…"></textarea>
      <div class="cv" id="cv_bump3"></div>

      <!-- Notes (prompt editor) -->
      <label>Notes about campaign</label>
      <div class="toolbar">
        <button class="tb-btn" data-cmd="bold" type="button">Bold</button>
        <button class="tb-btn" data-cmd="italic" type="button">Italic</button>
        <button class="tb-btn" data-cmd="insertUnorderedList" type="button">Bullets</button>
        <span class="small">This saves HTML.</span>
      </div>
      <div id="notes" class="prompt" contenteditable="true" data-placeholder="Write notes/prompts here…"></div>
      <div class="cv" id="cv_notes"></div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn" id="submitBtn">Submit</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
        <span class="status" id="status"></span>
      </div>
    </div>
  </div>

<script>
  // -------- CONFIG: set your webhook endpoints here ----------
  const FETCH_URL  = "https://api.visquanta.com/webhook/custom-agent-fetch";   // GET or POST acceptable; we use POST with JSON
  const SUBMIT_URL = "https://api.visquanta.com/webhook/custom-agent-set-up";  // already live per your earlier note
  const AGENT_COUNT = 5;
  // -----------------------------------------------------------

  // Helpers
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";
  const locationId = get("locationId");
  const businessName = get("businessName");

  // Header lines
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  // Build tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENT_COUNT;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Custom campaign agent ${i}`;
    t.dataset.agent = i;
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const toggle = document.getElementById("activeToggle");
  const activeLabel = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");
  const perDay = document.getElementById("perDay");
  const cadence = document.getElementById("cadence");
  const firstMessage = document.getElementById("firstMessage");
  const bump1 = document.getElementById("bump1");
  const bump2 = document.getElementById("bump2");
  const bump3 = document.getElementById("bump3");
  const notes = document.getElementById("notes");
  const statusEl = document.getElementById("status");
  const submitBtn = document.getElementById("submitBtn");

  // "Current value" labels
  const cv = {
    active:  document.getElementById("cv_active"),
    campaign:document.getElementById("cv_campaign"),
    perday:  document.getElementById("cv_perday"),
    cadence: document.getElementById("cv_cadence"),
    firstmsg:document.getElementById("cv_firstmsg"),
    bump1:   document.getElementById("cv_bump1"),
    bump2:   document.getElementById("cv_bump2"),
    bump3:   document.getElementById("cv_bump3"),
    notes:   document.getElementById("cv_notes"),
  };

  // Per-agent working state (what user is editing)
  const working = {};
  // Per-agent "current values" (from your fetch webhook)
  const current = {};

  // Toggle helpers
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token insert
  let focusTarget = null;
  [firstMessage, bump1, bump2, bump3].forEach(el=> el.addEventListener("focus", ()=> focusTarget = el));
  document.getElementById("insertToken").addEventListener("click", ()=>{
    const token = (document.getElementById("tokenSelect")).value;
    const el = focusTarget || firstMessage;
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0,start) + token + el.value.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
  });

  // Reset
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    campaignName.value=""; perDay.value="100"; cadence.selectedIndex=0;
    firstMessage.value=""; bump1.value=""; bump2.value=""; bump3.value=""; notes.innerHTML="";
    setActive(false); setStatus("");
  });

  function setStatus(text, ok){
    if (!text){ statusEl.textContent=""; return; }
    statusEl.textContent = text;
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setLoading(text="Updating…"){
    statusEl.innerHTML = `<span class="spinner"></span>${text}`;
  }
  function setCV(el, value){
    el.textContent = "Current value: " + (value ? String(value) : "(not set)");
  }

  // Key generator for a given agent number (1..5)
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:   base + "active_yes_or_leave_blank",
      bump1:    base + "bump_1",
      bump2:    base + "bump_2",
      bump3:    base + "bump_3",
      campaign: base + "campaign_name",
      firstmsg: base + "first_message",
      cadence:  base + "follow_up_cadence",
      perday:   base + "how_many_per_day_see_sop",
      notes:    base + "notes_about_campaign"
    };
  }

  // Optionally allow URL overrides like key_active_3=your_custom_key
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`);
      if (q) map[field] = q;
    }
    return map;
  }

  // Current agent
  let agent = 1;

  // Switch tabs
  function switchAgent(n){
    // Save working values of current tab
    working[agent] = getFormValues();

    // Activate tab
    [...tabsEl.children].forEach(btn=> btn.classList.toggle("active", Number(btn.dataset.agent)===n));
    agent = n;

    // Hydrate form with user's working state if present, else show empty inputs
    const w = working[agent] || {};
    campaignName.value = w.campaign || "";
    perDay.value = w.perday || (current[agent]?.perday || "100");
    cadence.value = w.cadence || (current[agent]?.cadence || "IM > 15m > 24h > 24h");
    firstMessage.value = w.firstmsg || "";
    bump1.value = w.bump1 || "";
    bump2.value = w.bump2 || "";
    bump3.value = w.bump3 || "";
    notes.innerHTML = w.notes || "";

    setActive( (w.active ?? (current[agent]?.active?.toLowerCase()==="yes")) ? true:false );

    // Refresh "Current value" hints for this agent
    setCV(cv.active,  current[agent]?.active);
    setCV(cv.campaign,current[agent]?.campaign);
    setCV(cv.perday,  current[agent]?.perday);
    setCV(cv.cadence, current[agent]?.cadence);
    setCV(cv.firstmsg,current[agent]?.firstmsg);
    setCV(cv.bump1,   current[agent]?.bump1);
    setCV(cv.bump2,   current[agent]?.bump2);
    setCV(cv.bump3,   current[agent]?.bump3);
    setCV(cv.notes,   current[agent]?.notes);

    setStatus("");
  }

  // Gather values from form
  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      perday:   perDay.value,
      cadence:  cadence.value,
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.innerHTML
    };
  }

  // Submit
  document.getElementById("submitBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);

    // keep working state up to date
    working[agent] = getFormValues();

    // Build keys for this agent
    let keys = cvKeys(agent);
    keys = overrideKeysFromQuery(keys, agent);

    const payload = {
      locationId,
      businessName,
      agent,
      keys,
      data: {
        "Custom campaign agent " + agent + " – Active": working[agent].active,
        "Custom campaign agent " + agent + " – Campaign name": working[agent].campaign,
        "Custom campaign agent " + agent + " – How many per day": working[agent].perday,
        "Custom campaign agent " + agent + " – Follow up cadence": working[agent].cadence,
        "Custom campaign agent " + agent + " – First message": working[agent].firstmsg,
        "Custom campaign agent " + agent + " – Bump 1": working[agent].bump1,
        "Custom campaign agent " + agent + " – Bump 2": working[agent].bump2,
        "Custom campaign agent " + agent + " – Bump 3": working[agent].bump3,
        "Custom campaign agent " + agent + " – Notes about campaign": working[agent].notes
      }
    };

    submitBtn.disabled = true;
    setLoading("Updating…");

    try{
      const res = await fetch(SUBMIT_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const json = await res.json().catch(()=> ({}));
      if (String(json?.response).toLowerCase()==="complete"){ setStatus("Complete", true); }
      else if (!res.ok){ setStatus(`Error ${res.status}: ${json?.message || "Request failed"}`); }
      else { setStatus("Saved", true); }
    }catch{
      setStatus("Network error. Try again.");
    }finally{
      submitBtn.disabled = false;
    }
  });

  // Initial fetch: pull current values for ALL agents via locationId
  (async function init(){
    // Build tabs state
    for (let i=1;i<=AGENT_COUNT;i++){ working[i]={}; current[i]={}; }

    if (!locationId) return;

    setLoading("Loading current values…");
    try{
      const res = await fetch(FETCH_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ locationId }) });
      const json = await res.json().catch(()=> ({}));
      // Expected shape (flexible): { agents: { "1": {active:"Yes",campaign:"...",perday:"100",...}, "2": {...}, ... } }
      const agents = json?.agents || {};
      for (let i=1;i<=AGENT_COUNT;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? "",        // "Yes" or ""
          campaign: a.campaign ?? "",
          perday:   a.perday ?? "",
          cadence:  a.cadence ?? "",
          firstmsg: a.firstmsg ?? "",
          bump1:    a.bump1 ?? "",
          bump2:    a.bump2 ?? "",
          bump3:    a.bump3 ?? "",
          notes:    a.notes ?? ""
        };
      }
      setStatus("");
    }catch{
      setStatus("Could not load current values (fetch webhook).", false);
    }

    // Show Agent 1 after fetch
    switchAgent(1);
  })();
</script>
</body>
</html>
