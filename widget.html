<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36;
    --orange:#ed6c03; --red:#ef4444; --green:#10b981;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }

  /* Top toolbar */
  .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .sop{ background:var(--red); color:#000; font-weight:800; border:none; text-decoration:none; padding:8px 12px; border-radius:12px; box-shadow:0 6px 14px rgba(239,68,68,.35); }
  .sop:hover{ filter:brightness(1.05); }

  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }

  /* Sticky tabs */
  .tabs-wrap{ position:sticky; top:0; z-index:20; padding:10px 0 8px; background:linear-gradient(var(--bg), rgba(15,17,21,.92)); backdrop-filter: blur(2px); }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--line); padding:10px 14px; border-radius:999px; background:#0e1117; cursor:pointer; font-weight:700; font-size:13px; color:#cfd6e4; transition:.15s; }
  .tab:hover{ border-color:#3a404a; }
  .tab.active{ background:var(--orange); color:#000; border-color:var(--orange); box-shadow:0 6px 16px rgba(237,108,3,.35); }

  /* Editing bar */
  .editing{ display:flex; align-items:center; gap:10px; margin:10px 0 12px; flex-wrap:wrap; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700;
    background:rgba(237,108,3,.14); color:#ffd9b8; border:1px solid rgba(237,108,3,.45); }
  .xbtn{ background:transparent; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer; }
  .copy-note{ font-size:12px; color:#a7f3d0; }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }

  .label-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{
    width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
  }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }

  /* Actions */
  .actions{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:18px; }
  .actions.hidden{ display:none; }
  .btn{ background:var(--orange); color:#000; border:0; padding:14px 28px; border-radius:14px; font-weight:800; font-size:16px; cursor:pointer; }
  .btn.secondary{ background:transparent; border:1px solid var(--line); color:#fff; }
  .status{ font-size:13px; color:var(--muted); text-align:center; display:block; margin-top:8px; }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Token inserter */
  .ti{ display:flex; gap:8px; align-items:center; margin:6px 0 8px; }
  .ti select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .ti button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* Current value chip */
  .cv{ margin-top:6px; font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #2a2f37; background:#0f141a; display:inline-block; }
  .cv strong{ font-weight:800; }
  .cv.has-value{ border-color:rgba(16,185,129,.55); background:rgba(16,185,129,.10); color:#a7f3d0; } /* green */
  .cv.empty{ border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.10); color:#fecaca; }  /* red */

  /* Divider (extra space) */
  .divider{ height:1px; background:var(--line); margin:30px 0; opacity:.8; }

  /* Overlay loader */
  .overlay{ position:fixed; inset:0; background:rgba(15,17,21,.72); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .overlay.hidden{ display:none; }
  .loading{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .bigspin{ width:46px; height:46px; border:5px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:999px; animation:spin .9s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Examples modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10000; }
  .modal.show{ display:flex; }
  .modal-card{ width:min(820px, 92vw); background:#0f141a; border:1px solid #273042; border-radius:16px; padding:16px; box-shadow:0 16px 48px rgba(0,0,0,.5); }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .modal-title{ font-weight:800; }
  .ex-list{ display:flex; flex-direction:column; gap:14px; }
  .ex-group{ border:1px solid #263142; border-radius:12px; padding:10px; background:#0b0f14; }
  .ex-group h4{ margin:0 0 8px; font-size:13px; color:#a7b0c0; letter-spacing:.2px; }
  .ex-item{ border:1px solid #263142; border-radius:10px; padding:10px; background:#0f141a; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .ex-text{ white-space:pre-wrap; color:#dbe2f0; font-size:14px; line-height:1.35; }
  .usebtn{ background:var(--green); color:#052; font-weight:800; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="sop" href="https://airtable.com/appZY3R7wWCzEsIZT/pagMdmBUMsAVRNYMe?ZHpwB=recPcFlbdOVjRopk2" target="_blank" rel="noopener">Link to SOP</a>
    </div>

    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <div class="tabs-wrap"><div class="tabs" id="tabs"></div></div>

    <div class="editing">
      <span class="sub">Editing:</span>
      <span class="chip" id="agentChip">Custom campaign agent 1</span>
      <button class="xbtn" id="copyPrevBtn" title="Copy current values from previous agent">Copy prev</button>
      <span class="copy-note" id="copyNote"></span>
    </div>

    <div class="card" id="formCard">
      <!-- Active -->
      <div class="label-row">
        <label>Active? ("Yes" or leave blank)</label>
      </div>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv empty" id="cv_active"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Campaign name -->
      <div class="label-row"><label>Campaign name</label></div>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv empty" id="cv_campaign"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Objective reached block -->
      <div class="row">
        <div>
          <label>Objective reached trigger phrase</label>
          <input type="text" id="objTrigger" placeholder="e.g. booked, deposit, sold…" />
          <div class="cv empty" id="cv_objTrigger"><strong>Current value:</strong> (not set)</div>
        </div>
        <div>
          <label>Objective reached webhook Endpoint</label>
          <input type="text" id="objWebhook" placeholder="https://…" />
          <div class="cv empty" id="cv_objWebhook"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Per day + Cadence -->
      <div class="row">
        <div>
          <label>How many per day</label>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>150</option><option>200</option><option>250</option><option>300</option>
            <option>350</option><option>500</option><option selected>100</option>
          </select>
          <div class="cv empty" id="cv_perday"><strong>Current value:</strong> (not set)</div>
        </div>
        <div>
          <label>Follow up cadence</label>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv empty" id="cv_cadence"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- First message -->
      <div class="label-row">
        <label>First message</label>
        <button class="xbtn ex-btn" data-target="firstMessage" data-kind="first">Examples</button>
      </div>
      <div class="ti" data-target="firstMessage">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="firstMessage" class="big" placeholder="Type the first message…"></textarea>
      <div class="cv empty" id="cv_firstmsg"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 1 -->
      <div class="label-row">
        <label>Bump 1</label>
        <button class="xbtn ex-btn" data-target="bump1" data-kind="bump1">Examples</button>
      </div>
      <div class="ti" data-target="bump1">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump1" class="big" placeholder="Bump 1…"></textarea>
      <div class="cv empty" id="cv_bump1"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 2 -->
      <div class="label-row">
        <label>Bump 2</label>
        <button class="xbtn ex-btn" data-target="bump2" data-kind="bump2">Examples</button>
      </div>
      <div class="ti" data-target="bump2">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump2" class="big" placeholder="Bump 2…"></textarea>
      <div class="cv empty" id="cv_bump2"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 3 -->
      <div class="label-row">
        <label>Bump 3</label>
        <button class="xbtn ex-btn" data-target="bump3" data-kind="bump3">Examples</button>
      </div>
      <div class="ti" data-target="bump3">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump3" class="big" placeholder="Bump 3…"></textarea>
      <div class="cv empty" id="cv_bump3"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Notes -->
      <div class="label-row"><label>Notes about campaign</label></div>
      <div class="ti" data-target="notes">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="notes" class="big" placeholder="Write notes/prompts here…"></textarea>
      <div class="cv empty" id="cv_notes"><strong>Current value:</strong> (not set)</div>

      <!-- Actions -->
      <div class="actions" id="actionsRow">
        <button class="btn" id="submitBtn">Save Agent 1</button>
        <button class="btn secondary" id="saveNextBtn" title="Save then move to the next agent">Save & Next</button>
      </div>
      <span class="status" id="status"></span>
    </div>
  </div>

  <!-- Overlay loader -->
  <div id="overlay" class="overlay hidden" aria-live="polite" aria-busy="true">
    <div class="loading"><div class="bigspin"></div><div id="overlayText">Loading…</div></div>
  </div>

  <!-- Examples modal -->
  <div id="exModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="exTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="exTitle">Examples</div>
        <button class="xbtn" id="exClose">Close</button>
      </div>
      <div class="ex-list" id="exList"></div>
    </div>
  </div>

<script>
  /* ------------------- URL CONFIG (no secrets in code!) ------------------- */
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";

  const FETCH_URL  = decodeURIComponent(get("fetchUrl")  || "");
  const SUBMIT_URL = decodeURIComponent(get("submitUrl") || "");
  const AUTH_HEADER = get("authHeader") || "";        // e.g. Authorization
  const AUTH_TOKEN  = get("authToken")  || "";        // e.g. Bearer abc123
  const APIKEY_HEADER = get("apiKeyHeader") || "";    // e.g. x-api-key
  const APIKEY_VALUE  = get("apiKey")      || "";     // key value
  const AGENT_COUNT = 5;

  function buildHeaders(){
    const h = { "Content-Type":"application/json" };
    if (AUTH_HEADER && AUTH_TOKEN) h[AUTH_HEADER] = AUTH_TOKEN;
    if (APIKEY_HEADER && APIKEY_VALUE) h[APIKEY_HEADER] = APIKEY_VALUE;
    return h;
  }
  /* ----------------------------------------------------------------------- */

  // Example library
  const EXAMPLES = {
    first: [
      { group: "Dealership — conversational ‘blast’", items: [
        "Hey {{contact.first_name}}, it’s {{location.name}} — want a short list of great {{contact.year_of_vehicle_manufacture}} {{contact.make}} {{contact.model}} matches?",
        "Hi {{contact.first_name}}, quick one from {{location.name}} — still open to options if I text you a few?",
        "{{contact.first_name}}, it’s {{location.name}}. 1 minute chat to nail down make/model & budget?",
        "Hello {{contact.first_name}} — if you tell me year/make/style, I’ll send 3 options that fit.",
        "Hey {{contact.first_name}}! I can price-match and hold a test drive slot. Want me to text times?"
      ] }
    ],
    bump1: [
      { group: "Default", items: [
        "Hopefully I have the right number — is this {{contact.first_name}}?"
      ]},
      { group: "US — Southern", items: [
        "Howdy {{contact.first_name}} — making sure I’ve got the right person. This you?",
        "Hi there {{contact.first_name}}! Quick tap-back to confirm I reached ya?"
      ]},
      { group: "US — Eastern", items: [
        "Hey {{contact.first_name}}, checking I’ve got the right number. You good to text here?",
        "{{contact.first_name}} — quick confirm this is you so I can send options?"
      ]},
      { group: "US — Western", items: [
        "Hi {{contact.first_name}}! Just confirming this is your best number to text a few picks.",
        "Hey {{contact.first_name}}, pinging you here — still you?"
      ]},
      { group: "UK — South", items: [
        "Hello {{contact.first_name}}, quick check this is you — happy to send a shortlist.",
        "Hi {{contact.first_name}}, is this the right number to share options?"
      ]},
      { group: "UK — North", items: [
        "Hiya {{contact.first_name}}, that you? I’ll pop over a few choices if so.",
        "Alright {{contact.first_name}} — this your number? I can send some motors to consider."
      ]},
      { group: "Canada", items: [
        "Hey {{contact.first_name}} — just confirming I’ve reached you. Want me to text options, eh?",
        "Hi {{contact.first_name}}, checking this is your number — I can send a couple of picks."
      ]}
    ],
    bump2: [
      { group: "Polite follow-up", items: [
        "Just making sure I’ve got the right person — is this {{contact.first_name}}?",
        "{{contact.first_name}}, is this still your number? Want to make sure I reach you.",
        "Double checking contact info — still you, {{contact.first_name}}?"
      ] }
    ],
    bump3: [
      { group: "Close loop", items: [
        "Just circling back {{contact.first_name}}. Need any help from us at {{location.name}}?",
        "If timing’s not right, no worries — I’ll be here when you’re ready, {{contact.first_name}}.",
        "Want me to book a call or set a test drive, {{contact.first_name}}?"
      ] }
    ]
  };

  const locationId   = get("locationId");
  const businessName = get("businessName");

  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const showOverlay = (t="Loading…") => { overlayText.textContent=t; overlay.classList.remove("hidden"); };
  const hideOverlay = () => overlay.classList.add("hidden");

  // Header
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  // Tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENT_COUNT;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Agent ${i}`;
    t.dataset.agent = i;
    t.setAttribute("aria-selected", i===1 ? "true" : "false");
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const agentChip    = document.getElementById("agentChip");
  const copyPrevBtn  = document.getElementById("copyPrevBtn");
  const copyNote     = document.getElementById("copyNote");

  const toggle       = document.getElementById("activeToggle");
  const activeLabel  = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");
  const objTrigger   = document.getElementById("objTrigger");
  const objWebhook   = document.getElementById("objWebhook");
  const perDay       = document.getElementById("perDay");
  const cadence      = document.getElementById("cadence");
  const firstMessage = document.getElementById("firstMessage");
  const bump1        = document.getElementById("bump1");
  const bump2        = document.getElementById("bump2");
  const bump3        = document.getElementById("bump3");
  const notes        = document.getElementById("notes");
  const statusEl     = document.getElementById("status");
  const actionsRow   = document.getElementById("actionsRow");
  const submitBtn    = document.getElementById("submitBtn");
  const saveNextBtn  = document.getElementById("saveNextBtn");

  const cv = {
    active:   document.getElementById("cv_active"),
    campaign: document.getElementById("cv_campaign"),
    objTrigger: document.getElementById("cv_objTrigger"),
    objWebhook: document.getElementById("cv_objWebhook"),
    perday:   document.getElementById("cv_perday"),
    cadence:  document.getElementById("cv_cadence"),
    firstmsg: document.getElementById("cv_firstmsg"),
    bump1:    document.getElementById("cv_bump1"),
    bump2:    document.getElementById("cv_bump2"),
    bump3:    document.getElementById("cv_bump3"),
    notes:    document.getElementById("cv_notes"),
  };

  // Working/current
  const working = {};
  const current = {};

  // Toggle behavior
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
    recalcSaveVisibility();
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token inserter
  function insertTokenInto(el, token){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    const cur   = el.value || "";
    el.value = cur.slice(0,start) + token + cur.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
    recalcSaveVisibility();
  }
  document.querySelectorAll(".ti").forEach(ti=>{
    const target = document.getElementById(ti.dataset.target);
    const sel = ti.querySelector("select");
    const btn = ti.querySelector("button");
    btn.addEventListener("click", ()=> insertTokenInto(target, sel.value));
  });

  // Input listeners to control Save visibility
  [campaignName,objTrigger,objWebhook,perDay,cadence,firstMessage,bump1,bump2,bump3,notes].forEach(el=>{
    el.addEventListener("input", recalcSaveVisibility);
    el.addEventListener("change", recalcSaveVisibility);
  });

  function setStatus(text, ok){
    if (!text){ statusEl.textContent=""; return; }
    statusEl.textContent = text;
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setCV(el, value){
    const has = !!(value && String(value).trim());
    el.innerHTML = `<strong>Current value:</strong> ${has ? String(value) : "(not set)"}`;
    el.classList.toggle("has-value", has);
    el.classList.toggle("empty", !has);
  }

  // Keys for agent
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:   base + "active_yes_or_leave_blank",
      bump1:    base + "bump_1",
      bump2:    base + "bump_2",
      bump3:    base + "bump_3",
      campaign: base + "campaign_name",
      firstmsg: base + "first_message",
      cadence:  base + "follow_up_cadence",
      perday:   base + "how_many_per_day_see_sop",
      notes:    base + "notes_about_campaign",
      objTrigger: base + "objective_reached_trigger_phrase",
      objWebhook: base + "objective_reached_webhook_endpoint"
    };
  }
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`);
      if (q) map[field] = q;
    }
    return map;
  }

  let agent = 1;

  function renderCV(){
    setCV(cv.active,     current[agent]?.active);
    setCV(cv.campaign,   current[agent]?.campaign);
    setCV(cv.objTrigger, current[agent]?.objectiveTrigger);
    setCV(cv.objWebhook, current[agent]?.objectiveWebhook);
    setCV(cv.perday,     current[agent]?.perday);
    setCV(cv.cadence,    current[agent]?.cadence);
    setCV(cv.firstmsg,   current[agent]?.firstmsg);
    setCV(cv.bump1,      current[agent]?.bump1);
    setCV(cv.bump2,      current[agent]?.bump2);
    setCV(cv.bump3,      current[agent]?.bump3);
    setCV(cv.notes,      current[agent]?.notes);
  }

  function isEmpty(v){ return !v || !String(v).trim(); }

  function recalcSaveVisibility(){
    const hasAny =
      (toggle.classList.contains("on")) ||
      !isEmpty(campaignName.value) ||
      !isEmpty(objTrigger.value) ||
      !isEmpty(objWebhook.value) ||
      !isEmpty(perDay.value) ||
      !isEmpty(cadence.value) ||
      !isEmpty(firstMessage.value) ||
      !isEmpty(bump1.value) ||
      !isEmpty(bump2.value) ||
      !isEmpty(bump3.value) ||
      !isEmpty(notes.value);
    actionsRow.classList.toggle("hidden", !hasAny && areAllCurrentEmpty(agent));
  }
  function areAllCurrentEmpty(n){
    const a = current[n] || {};
    return ["active","campaign","objectiveTrigger","objectiveWebhook","perday","cadence","firstmsg","bump1","bump2","bump3","notes"]
      .every(k => isEmpty(a[k]));
  }

  function switchAgent(n){
    // Save edits for current tab
    working[agent] = getFormValues();

    // Highlight tab
    [...tabsEl.children].forEach(btn=>{
      const is = Number(btn.dataset.agent)===n;
      btn.classList.toggle("active", is);
      btn.setAttribute("aria-selected", is ? "true" : "false");
    });

    agent = n;
    agentChip.textContent = `Custom campaign agent ${agent}`;
    submitBtn.textContent = `Save Agent ${agent}`;
    document.title = `Agent ${agent} • Custom agent set up`;

    // Hide Copy button on Agent 1, show otherwise
    copyPrevBtn.style.display = agent === 1 ? "none" : "inline-flex";
    copyNote.textContent = "";

    // Prefill precedence: edits → current[agent] → previous agent → defaults
    const w = working[agent] || {};
    const prevIndex = agent === 1 ? AGENT_COUNT : agent - 1;

    const curA = current[agent] || {};
    const prevA = current[prevIndex] || {};

    campaignName.value = w.campaign || curA.campaign || prevA.campaign || "";
    objTrigger.value   = w.objectiveTrigger || curA.objectiveTrigger || prevA.objectiveTrigger || "";
    objWebhook.value   = w.objectiveWebhook || curA.objectiveWebhook || prevA.objectiveWebhook || "";
    perDay.value       = w.perday   || curA.perday   || prevA.perday   || perDay.value;
    cadence.value      = w.cadence  || curA.cadence  || prevA.cadence  || cadence.value;
    firstMessage.value = w.firstmsg || curA.firstmsg || prevA.firstmsg || "";
    // Bump1 default if totally empty:
    const bump1Default = "Hopefully I have the right number — is this {{contact.first_name}}?";
    bump1.value        = w.bump1    || curA.bump1    || prevA.bump1    || bump1Default;
    bump2.value        = w.bump2    || curA.bump2    || prevA.bump2    || "";
    bump3.value        = w.bump3    || curA.bump3    || prevA.bump3    || "";
    notes.value        = w.notes    || curA.notes    || prevA.notes    || "";

    const activeSeed = (w.active || curA.active || prevA.active || "");
    setActive( activeSeed.toLowerCase()==="yes" );

    renderCV();
    recalcSaveVisibility();
    setStatus("");
  }

  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      objectiveTrigger: objTrigger.value.trim(),
      objectiveWebhook: objWebhook.value.trim(),
      perday:   perDay.value,
      cadence:  cadence.value,
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.value
    };
  }

  // Build subsets of changed data + keys (only send what changed)
  function diffData(n){
    const now = getFormValues();
    const cur = current[n] || {};
    const mapLabel = {
      active:   `Custom campaign agent ${n} – Active`,
      campaign: `Custom campaign agent ${n} – Campaign name`,
      objectiveTrigger: `Custom campaign agent ${n} – Objective reached trigger phrase`,
      objectiveWebhook: `Custom campaign agent ${n} – Objective reached webhook Endpoint`,
      perday:   `Custom campaign agent ${n} – How many per day`,
      cadence:  `Custom campaign agent ${n} – Follow up cadence`,
      firstmsg: `Custom campaign agent ${n} – First message`,
      bump1:    `Custom campaign agent ${n} – Bump 1`,
      bump2:    `Custom campaign agent ${n} – Bump 2`,
      bump3:    `Custom campaign agent ${n} – Bump 3`,
      notes:    `Custom campaign agent ${n} – Notes about campaign`
    };

    const changedData = {};
    for (const k of Object.keys(mapLabel)){
      const before = (cur[k] ?? "");
      const after  = (now[k] ?? "");
      if (String(before) !== String(after)){
        changedData[ mapLabel[k] ] = after;
      }
    }
    return changedData;
  }

  // Save (single)
  submitBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);
    if (!SUBMIT_URL) return setStatus("Missing submitUrl in query string.", false);
    await saveAgentThenRefresh(agent, { jumpToNext:false });
  });

  // Save & Next
  saveNextBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);
    if (!SUBMIT_URL) return setStatus("Missing submitUrl in query string.", false);
    await saveAgentThenRefresh(agent, { jumpToNext:true });
  });

  async function saveAgentThenRefresh(agentNum, { jumpToNext }){
    // changed-only payload
    const changed = diffData(agentNum);
    if (!Object.keys(changed).length){
      setStatus("No changes to save.", true);
      return;
    }

    let keysFull = overrideKeysFromQuery(cvKeys(agentNum), agentNum);
    // Reduce keys map to only the fields we’re sending
    const reverseLabelToKey = {
      [`Custom campaign agent ${agentNum} – Active`] : "active",
      [`Custom campaign agent ${agentNum} – Campaign name`] : "campaign",
      [`Custom campaign agent ${agentNum} – Objective reached trigger phrase`] : "objTrigger",
      [`Custom campaign agent ${agentNum} – Objective reached webhook Endpoint`] : "objWebhook",
      [`Custom campaign agent ${agentNum} – How many per day`] : "perday",
      [`Custom campaign agent ${agentNum} – Follow up cadence`] : "cadence",
      [`Custom campaign agent ${agentNum} – First message`] : "firstmsg",
      [`Custom campaign agent ${agentNum} – Bump 1`] : "bump1",
      [`Custom campaign agent ${agentNum} – Bump 2`] : "bump2",
      [`Custom campaign agent ${agentNum} – Bump 3`] : "bump3",
      [`Custom campaign agent ${agentNum} – Notes about campaign`] : "notes"
    };
    const keysSubset = {};
    for (const label of Object.keys(changed)){
      const k = reverseLabelToKey[label];
      if (k) keysSubset[k] = keysFull[k];
    }

    const payload = {
      locationId, businessName, agent: agentNum,
      keys: keysSubset,
      data: changed
    };

    submitBtn.disabled = true;
    saveNextBtn.disabled = true;
    showOverlay("Saving…");

    try{
      const res = await fetch(SUBMIT_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify(payload)
      });
      await res.json().catch(()=> ({}));

      // After 3s refresh and (optionally) jump
      setTimeout(async ()=>{
        await refreshFromServer();
        if (jumpToNext){
          const next = agentNum === AGENT_COUNT ? 1 : agentNum + 1;
          switchAgent(next);
        }
      }, 3000);
    }catch{
      setStatus("Network error. Try again.");
      hideOverlay();
    }finally{
      submitBtn.disabled = false;
      saveNextBtn.disabled = false;
    }
  }

  async function refreshFromServer(){
    if (!locationId) return;
    if (!FETCH_URL){ setStatus("Missing fetchUrl in query string.", false); return; }
    showOverlay("Refreshing…");
    const urlWithBust = FETCH_URL + (FETCH_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    try{
      const res = await fetch(urlWithBust, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify({ locationId })
      });
      const json = await res.json().catch(()=> ({}));
      const agents = json?.agents || {};
      for (let i=1;i<=AGENT_COUNT;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? "",
          campaign: a.campaign ?? "",
          objectiveTrigger: a.objectiveTrigger ?? a.objective_trigger ?? "",
          objectiveWebhook: a.objectiveWebhook ?? a.objective_webhook ?? "",
          perday:   a.perday ?? "",
          cadence:  a.cadence ?? "",
          firstmsg: a.firstmsg ?? "",
          bump1:    a.bump1 ?? "",
          bump2:    a.bump2 ?? "",
          bump3:    a.bump3 ?? "",
          notes:    a.notes ?? ""
        };
      }
      renderCV();
      recalcSaveVisibility();
      setStatus("Refreshed", true);
    }catch{
      setStatus("Could not refresh current values.", false);
    }finally{
      hideOverlay();
    }
  }

  // Copy from previous agent (uses CURRENT values)
  copyPrevBtn.addEventListener("click", ()=>{
    const prev = agent === 1 ? AGENT_COUNT : agent - 1;
    const src = current[prev] || {};
    setActive((src.active || "").toLowerCase()==="yes");
    campaignName.value = src.campaign || "";
    objTrigger.value   = src.objectiveTrigger || "";
    objWebhook.value   = src.objectiveWebhook || "";
    perDay.value       = src.perday   || perDay.value;
    cadence.value      = src.cadence  || cadence.value;
    firstMessage.value = src.firstmsg || "";
    bump1.value        = src.bump1    || bump1.value;
    bump2.value        = src.bump2    || "";
    bump3.value        = src.bump3    || "";
    notes.value        = src.notes    || "";
    copyNote.textContent = `Copied values from Agent ${prev}.`;
    setTimeout(()=> copyNote.textContent="", 3500);
    recalcSaveVisibility();
  });

  // Examples modal logic
  const exModal = document.getElementById("exModal");
  const exList  = document.getElementById("exList");
  const exClose = document.getElementById("exClose");
  document.querySelectorAll(".ex-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const kind = btn.dataset.kind;          // first | bump1 | bump2 | bump3
      const targetId = btn.dataset.target;    // textarea id
      const groups = EXAMPLES[kind] || [];
      exList.innerHTML = "";
      document.getElementById("exTitle").textContent = `Examples — ${kind.replace(/^./,c=>c.toUpperCase())}`;
      groups.forEach(g=>{
        const block = document.createElement("div");
        block.className = "ex-group";
        const h = document.createElement("h4"); h.textContent = g.group;
        block.appendChild(h);
        (g.items||[]).forEach(txt=>{
          const row = document.createElement("div");
          row.className = "ex-item";
          const p = document.createElement("div");
          p.className = "ex-text";
          p.textContent = txt;
          const use = document.createElement("button");
          use.className = "usebtn";
          use.textContent = "Use";
          use.onclick = () => {
            const field = document.getElementById(targetId);
            field.value = txt;
            exModal.classList.remove("show");
            field.focus();
            recalcSaveVisibility();
          };
          row.appendChild(p); row.appendChild(use);
          block.appendChild(row);
        });
        exList.appendChild(block);
      });
      exModal.classList.add("show");
    });
  });
  exClose.addEventListener("click", ()=> exModal.classList.remove("show"));
  exModal.addEventListener("click", (e)=>{ if (e.target===exModal) exModal.classList.remove("show"); });

  (async function init(){
    for (let i=1;i<=AGENT_COUNT;i++){ working[i]={}; current[i]={}; }
    if (!locationId){ setStatus("Missing locationId", false); return; }

    showOverlay("Loading current values…");
    await refreshFromServer();  // hides overlay
    switchAgent(1);
  })();
</script>
</body>
</html>
