<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom agent set up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#17191e; --muted:#a7b0c0; --line:#2b2f36; --orange:#ed6c03; --red:#ef4444; --green:#10b981; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:#fff; }
  .wrap{ max-width:980px; margin:24px auto; padding:20px; }

  /* Top toolbar */
  .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .sop{ background:var(--red); color:#000; font-weight:800; border:none; text-decoration:none; padding:8px 12px; border-radius:12px; box-shadow:0 6px 14px rgba(239,68,68,.35); }
  .sop:hover{ filter:brightness(1.05); }
  .xbtn{ background:transparent; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer; }

  h1{ margin:0 0 4px; font-size:22px; }
  .sub{ color:var(--muted); font-size:13px; margin:2px 0 12px; }

  /* Sticky tabs */
  .tabs-wrap{ position:sticky; top:0; z-index:20; padding:10px 0 8px; background:linear-gradient(var(--bg), rgba(15,17,21,.92)); backdrop-filter: blur(2px); }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--line); padding:10px 14px; border-radius:999px; background:#0e1117; cursor:pointer; font-weight:700; font-size:13px; color:#cfd6e4; transition:.15s; }
  .tab:hover{ border-color:#3a404a; }
  .tab.active{ background:var(--orange); color:#000; border-color:var(--orange); box-shadow:0 6px 16px rgba(237,108,3,.35); }

  /* Editing bar */
  .editing{ display:flex; align-items:center; gap:10px; margin:10px 0 12px; flex-wrap:wrap; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; background:rgba(237,108,3,.14); color:#ffd9b8; border:1px solid rgba(237,108,3,.45); }
  .copy-note{ font-size:12px; color:#a7f3d0; }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; box-shadow:0 10px 28px rgba(0,0,0,.28); }

  .label-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  label{ display:block; font-size:13px; color:#dbe2f0; margin:14px 0 6px; }
  input[type="text"], select, textarea{ width:100%; background:#11151b; color:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; }
  textarea.big{ min-height:120px; font-size:14px; line-height:1.4; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }

  /* Actions */
  .actions{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:18px; }
  .actions.hidden{ display:none; }
  .btn{ background:var(--orange); color:#000; border:0; padding:14px 28px; border-radius:14px; font-weight:800; font-size:16px; cursor:pointer; }
  .btn.secondary{ background:transparent; border:1px solid var(--line); color:#fff; }
  .status{ font-size:13px; color:var(--muted); text-align:center; display:block; margin-top:8px; }

  /* Toggle */
  .toggle{ position:relative; width:56px; height:30px; background:#0e1117; border:1px solid var(--line); border-radius:999px; cursor:pointer; display:inline-flex; align-items:center; padding:3px; transition:.2s; }
  .toggle.on{ background:rgba(237,108,3,.15); border-color:rgba(237,108,3,.4); }
  .knob{ width:24px; height:24px; background:#fff; border-radius:999px; transform:translateX(0); transition:.2s; }
  .toggle.on .knob{ transform:translateX(26px); background:#ffd3b1; }
  .toggle-label{ margin-left:10px; min-width:36px; font-size:13px; color:#fff; opacity:.9; }

  /* Token inserter */
  .ti{ display:flex; gap:8px; align-items:center; margin:6px 0 8px; }
  .ti select{ background:#0e1117; border:1px solid var(--line); color:#fff; border-radius:10px; padding:6px 10px; }
  .ti button{ background:transparent; color:#fff; border:1px dashed var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* Current value chip */
  .cv{ margin-top:6px; font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #2a2f37; background:#0f141a; display:inline-block; }
  .cv strong{ font-weight:800; }
  .cv.has-value{ border-color:rgba(16,185,129,.55); background:rgba(16,185,129,.10); color:#a7f3d0; }
  .cv.empty{ border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.10); color:#fecaca; }

  /* Divider */
  .divider{ height:1px; background:var(--line); margin:30px 0; opacity:.8; }

  /* Overlay loader */
  .overlay{ position:fixed; inset:0; background:rgba(15,17,21,.72); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .overlay.hidden{ display:none; }
  .loading{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .bigspin{ width:46px; height:46px; border:5px solid rgba(237,108,3,.25); border-top-color:var(--orange); border-radius:999px; animation:spin .9s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Examples modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10000; }
  .modal.show{ display:flex; }
  .modal-card{ width:min(820px, 92vw); background:#0f141a; border:1px solid #273042; border-radius:16px; padding:16px; box-shadow:0 16px 48px rgba(0,0,0,.5); }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .modal-title{ font-weight:800; }
  .ex-list{ display:flex; flex-direction:column; gap:14px; }
  .ex-group{ border:1px solid #263142; border-radius:12px; padding:10px; background:#0b0f14; }
  .ex-group h4{ margin:0 0 8px; font-size:13px; color:#a7b0c0; letter-spacing:.2px; }
  .ex-item{ border:1px solid #263142; border-radius:10px; padding:10px; background:#0f141a; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .ex-text{ white-space:pre-wrap; color:#dbe2f0; font-size:14px; line-height:1.35; }
  .usebtn{ background:var(--green); color:#052; font-weight:800; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }

  /* Webhook response */
  .resp{ margin-top:14px; }
  .resp.hidden{ display:none; }
  .resp pre{ background:#0b0f14; border:1px solid #263142; border-radius:12px; padding:12px; overflow:auto; max-height:280px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="sop" href="https://airtable.com/appZY3R7wWCzEsIZT/pagMdmBUMsAVRNYMe?ZHpwB=recPcFlbdOVjRopk2" target="_blank" rel="noopener">Link to SOP</a>
      <button class="xbtn" id="refreshBtn" title="Reload widget">Refresh</button>
    </div>

    <h1>Custom agent set up</h1>
    <div class="sub" id="bizLine"></div>
    <div class="sub" id="locLine"></div>

    <div class="tabs-wrap"><div class="tabs" id="tabs"></div></div>

    <div class="editing">
      <span class="sub">Editing:</span>
      <span class="chip" id="agentChip">Custom campaign agent 1</span>
      <button class="xbtn" id="copyPrevBtn" title="Copy current values from previous agent">Copy prev</button>
      <span class="copy-note" id="copyNote"></span>
    </div>

    <div class="card" id="formCard">
      <!-- Active -->
      <div class="label-row"><label>Active? ("Yes" or leave blank)</label></div>
      <div id="activeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      <span class="toggle-label" id="activeLabel">No</span>
      <div class="cv empty" id="cv_active"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Campaign name -->
      <div class="label-row"><label>Campaign name</label></div>
      <input type="text" id="campaignName" placeholder="Campaign name" />
      <div class="cv empty" id="cv_campaign"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Objective reached block -->
      <div class="row">
        <div>
          <label>Objective reached trigger phrase</label>
          <input type="text" id="objTrigger" placeholder="e.g. 'buying specialist will contact you soon to discuss the next steps'" />
          <div class="cv empty" id="cv_objTrigger"><strong>Current value:</strong> (not set)</div>
        </div>
        <div>
          <label>Objective reached webhook Endpoint</label>
          <input type="text" id="objWebhook" placeholder="https://â€¦" />
          <div class="cv empty" id="cv_objWebhook"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Per day + Cadence -->
      <div class="row">
        <div>
          <label>How many per day</label>
          <select id="perDay">
            <option>10</option><option>25</option><option>50</option><option>75</option>
            <option>150</option><option>200</option><option>250</option><option>300</option>
            <option>350</option><option>500</option><option selected>100</option>
          </select>
          <div class="cv empty" id="cv_perday"><strong>Current value:</strong> (not set)</div>
        </div>
        <div>
          <label>Follow up cadence</label>
          <select id="cadence">
            <option>IM > 15m > 24h > 24h</option>
            <option>IM > 24h > 24h > 24h</option>
            <option>IM > 24h > 48h > 72h</option>
            <option>IM > 48h > 48h > 48h</option>
            <option>IM > 72h > 72h > 72h</option>
            <option>IM > 7d > 7d > 7d</option>
          </select>
          <div class="cv empty" id="cv_cadence"><strong>Current value:</strong> (not set)</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- First message -->
      <div class="label-row">
        <label>First message</label>
        <button class="xbtn ex-btn" data-target="firstMessage" data-kind="first">Examples</button>
      </div>
      <div class="ti" data-target="firstMessage">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="firstMessage" class="big" placeholder="Type the first messageâ€¦"></textarea>
      <div class="cv empty" id="cv_firstmsg"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 1 -->
      <div class="label-row">
        <label>Bump 1</label>
        <button class="xbtn ex-btn" data-target="bump1" data-kind="bump1">Examples</button>
      </div>
      <div class="ti" data-target="bump1">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump1" class="big" placeholder="Bump 1â€¦"></textarea>
      <div class="cv empty" id="cv_bump1"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 2 -->
      <div class="label-row">
        <label>Bump 2</label>
        <button class="xbtn ex-btn" data-target="bump2" data-kind="bump2">Examples</button>
      </div>
      <div class="ti" data-target="bump2">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump2" class="big" placeholder="Bump 2â€¦"></textarea>
      <div class="cv empty" id="cv_bump2"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Bump 3 -->
      <div class="label-row">
        <label>Bump 3</label>
        <button class="xbtn ex-btn" data-target="bump3" data-kind="bump3">Examples</button>
      </div>
      <div class="ti" data-target="bump3">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="bump3" class="big" placeholder="Bump 3â€¦"></textarea>
      <div class="cv empty" id="cv_bump3"><strong>Current value:</strong> (not set)</div>

      <div class="divider"></div>

      <!-- Notes -->
      <div class="label-row">
        <label>Notes about campaign</label>
        <button class="xbtn ex-btn" data-target="notes" data-kind="notes">Examples</button>
      </div>
      <div class="ti" data-target="notes">
        <select>
          <option value="{{contact.first_name}}">First name</option>
          <option value="{{contact.last_name}}">Last name</option>
          <option value="{{contact.full_name}}">Full name</option>
          <option value="{{contact.email}}">Email</option>
          <option value="{{contact.phone}}">Phone</option>
          <option value="{{contact.year_of_vehicle_manufacture}}">Vehicle year</option>
          <option value="{{contact.make}}">Make</option>
          <option value="{{contact.model}}">Model</option>
          <option value="{{location.name}}">Business name</option>
        </select>
        <button type="button">Insert</button>
      </div>
      <textarea id="notes" class="big" placeholder="Write notes/prompts hereâ€¦"></textarea>
      <div class="cv empty" id="cv_notes"><strong>Current value:</strong> (not set)</div>

      <!-- Actions -->
      <div class="actions" id="actionsRow">
        <button class="btn" id="submitBtn">Save Agent 1</button>
        <button class="btn secondary" id="saveNextBtn" title="Save then move to the next agent">Save & Next</button>
      </div>
      <span class="status" id="status"></span>

      <!-- Webhook response -->
      <div class="resp hidden" id="respBox">
        <div class="label-row"><label>Webhook response</label></div>
        <pre id="respPre"></pre>
      </div>
    </div>
  </div>

  <!-- Overlay loader -->
  <div id="overlay" class="overlay hidden" aria-live="polite" aria-busy="true">
    <div class="loading"><div class="bigspin"></div><div id="overlayText">Loadingâ€¦</div></div>
  </div>

  <!-- Examples modal -->
  <div id="exModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="exTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="exTitle">Examples</div>
        <button class="xbtn" id="exClose">Close</button>
      </div>
      <div class="ex-list" id="exList"></div>
    </div>
  </div>

<script>
  /* ------------------- URL CONFIG (no secrets in code!) ------------------- */
  const qs = new URLSearchParams(location.search);
  const get = k => qs.get(k) || "";

  const FETCH_URL  = decodeURIComponent(get("fetchUrl")  || "");
  const SUBMIT_URL = decodeURIComponent(get("submitUrl") || "");
  const AUTH_HEADER = get("authHeader") || "";
  const AUTH_TOKEN  = get("authToken")  || "";
  const APIKEY_HEADER = get("apiKeyHeader") || "";
  const APIKEY_VALUE  = get("apiKey")      || "";
  const AGENTS = 5;

  function buildHeaders(){
    const h = { "Content-Type":"application/json" };
    if (AUTH_HEADER && AUTH_TOKEN) h[AUTH_HEADER] = AUTH_TOKEN;
    if (APIKEY_HEADER && APIKEY_VALUE) h[APIKEY_HEADER] = APIKEY_VALUE;
    return h;
  }
  /* ----------------------------------------------------------------------- */

  // Example library (all bumps have dialect sets)
  const EXAMPLES = {
    first: [
      { group: "Dealership â€” conversational â€˜blastâ€™", items: [
        "Hey {{contact.first_name}}, itâ€™s {{location.name}} â€” want a short list of great {{contact.year_of_vehicle_manufacture}} {{contact.make}} {{contact.model}} matches?",
        "Hi {{contact.first_name}}, quick one from {{location.name}} â€” still open to options if I text you a few?",
        "{{contact.first_name}}, itâ€™s {{location.name}}. 1-minute chat to nail down make/model & budget?",
        "Hello {{contact.first_name}} â€” if you tell me year/make/style, Iâ€™ll send 3 options that fit.",
        "Hey {{contact.first_name}}! I can price-match and hold a test drive slot. Want me to text times?"
      ] }
    ],
    bump1: [
      { group: "Default", items: [
        "Hopefully I have the right number â€” is this {{contact.first_name}}?"
      ]},
      { group: "US â€” Southern", items: [
        "Howdy {{contact.first_name}} â€” making sure Iâ€™ve got the right person. This you?",
        "Hi there {{contact.first_name}}! Quick tap-back to confirm I reached ya?"
      ]},
      { group: "US â€” Eastern", items: [
        "Hey {{contact.first_name}}, checking Iâ€™ve got the right number. You good to text here?",
        "{{contact.first_name}} â€” quick confirm this is you so I can send options?"
      ]},
      { group: "US â€” Western", items: [
        "Hi {{contact.first_name}}! Just confirming this is your best number to text a few picks.",
        "Hey {{contact.first_name}}, pinging you here â€” still you?"
      ]},
      { group: "UK â€” South", items: [
        "Hello {{contact.first_name}}, quick check this is you â€” happy to send a shortlist.",
        "Hi {{contact.first_name}}, is this the right number to share options?"
      ]},
      { group: "UK â€” North", items: [
        "Hiya {{contact.first_name}}, that you? Iâ€™ll pop over a few choices if so.",
        "Alright {{contact.first_name}} â€” this your number? I can send some motors to consider."
      ]},
      { group: "Canada", items: [
        "Hey {{contact.first_name}} â€” just confirming Iâ€™ve reached you. Want me to text options, eh?",
        "Hi {{contact.first_name}}, checking this is your number â€” I can send a couple of picks."
      ]}
    ],
    bump2: [
      { group: "Polite follow-up", items: [
        "Just making sure Iâ€™ve got the right person â€” is this {{contact.first_name}}?",
        "{{contact.first_name}}, is this still your number? Want to make sure I reach you.",
        "Double-checking contact info â€” still you, {{contact.first_name}}?"
      ]},
      { group: "US â€” Southern", items: [
        "Quick check, {{contact.first_name}} â€” this still your cell so I can send details?",
        "Mind confirming Iâ€™ve got ya, {{contact.first_name}}?"
      ]},
      { group: "US â€” Eastern", items: [
        "Can you confirm this numberâ€™s best for you, {{contact.first_name}}?",
        "Is this still you on text, {{contact.first_name}}?"
      ]},
      { group: "US â€” Western", items: [
        "Just verifying this is still the right line for you, {{contact.first_name}}.",
        "All good to text you here, {{contact.first_name}}?"
      ]},
      { group: "UK â€” South", items: [
        "Could you confirm this is your number, {{contact.first_name}}?",
        "Is this still the best number for you, {{contact.first_name}}?"
      ]},
      { group: "UK â€” North", items: [
        "Is this your best number, {{contact.first_name}}?",
        "Give us a quick yes if this is still you, {{contact.first_name}}."
      ]},
      { group: "Canada", items: [
        "Mind confirming this is your number, {{contact.first_name}}?",
        "Is this still the right number to reach you, {{contact.first_name}}?"
      ]}
    ],
    bump3: [
      { group: "Close loop / helpful", items: [
        "Just circling back {{contact.first_name}}. Need any help from us at {{location.name}}?",
        "If timingâ€™s not right, no worries â€” Iâ€™ll be here when youâ€™re ready, {{contact.first_name}}.",
        "Want me to book a call or set a test drive, {{contact.first_name}}?"
      ]},
      { group: "US â€” Southern", items: [
        "Checking in one last time, {{contact.first_name}} â€” want a hand lining up a test drive?",
        "Happy to help anytime. Shall I have a specialist ring you, {{contact.first_name}}?"
      ]},
      { group: "US â€” Eastern", items: [
        "Last check-in, {{contact.first_name}} â€” want me to slot a quick call?",
        "No rush â€” if you want options or an appointment, I can set it up."
      ]},
      { group: "US â€” Western", items: [
        "Looping back once more â€” want me to line up times for you, {{contact.first_name}}?",
        "I can get a specialist to reach out if youâ€™d like me to."
      ]},
      { group: "UK â€” South", items: [
        "One final check, {{contact.first_name}} â€” fancy a quick chat with a specialist?",
        "Happy to arrange a test drive when it suits you."
      ]},
      { group: "UK â€” North", items: [
        "Last nudge, {{contact.first_name}} â€” want me to sort a quick call?",
        "Give us a shout if you want me to get something booked."
      ]},
      { group: "Canada", items: [
        "Circling back once more â€” want me to book a chat with a specialist, {{contact.first_name}}?",
        "I can set up a test drive when youâ€™re ready."
      ]}
    ],
    notes: [
      { group: "Fresh Up Follow Up", items: [`
Fresh Up Follow Up

If the chat history indicates that the most recent agent to be activated is the "Fresh Up Follow Up" Agent, 

This means we are reaching out to a customer who who first visited the showroom 10 days ago. & the conversation objective is to invite them back toward rebooking an appointment. 

1.0 - We will be (re) introducing ourselves and asking how their vehicle search is. (We are skipping the assistant working from home message here in this convo.). This will be a short "Hey [their name], how are you? Its [your name] from [ dealership name]. I had a quick note here to reach out, how is the vehicle search going?" message.

2.0 - Once they tell us how they / their vehicle search is we want to ackowledge what they say empathetically and then continue with the defauklt qualified prospect section and any booking related criteria.

The best way to book an appointment is to schedule a call with a specialist who will walk them through any final things we need etc.

One question at a time per interaction.
`]},
      { group: "Service to Sales (Appraisal)", items: [`
Service to Sales (Appraisal)

If the chat history indicates that the most recent agent to be activated is the "Service to Sales (Appraisal)" Agent, 

This means we are reaching out to a customer who scheduled a service appointment very recently & the objective is to Invite them to have their vehicle appraised either online or get the process started over the phone with a specialist.

1.0 - We will be (re) introducing ourselves and asking how their vehicle is. (We are skipping the assistant working from home message here in this convo.). This will be a short "Hi [their name], it's [your name] from [dealership name] how are you and your [vehicle but without the year, just the model to appear human like, if nothing available, just use vehicle] doing?" message.

2.0 - Once they tell us how they / their vehicle is we want to ackowledge what they say empathetically 

and then on a new line say 

"I just wanted to quickly check-in, see how you were and also quickly ask if have you had you were interested in getting your [vehicle] appraised? 

2.1 - If they say yes, ask if they would like to do it online or if they would like to have an appraisal specialist reach out to them as.

3.1 - If they say online, send them this link: www.juneksbuysusedcars.com and say "Once you start, could you let me know when youâ€™ve submitted your info? That way, Iâ€™ll bring it up to the team."

3.1.1 - Once they are done, say "Great, thanks. A buying specialist will contact you soon to discuss the next steps" and then wish them a nice day (dont use take car or have a wonderful day here as the phrase "buying specialist will contact you soon to discuss the next steps" is the trigger phrase tool that will send to the buying team so make sure you use it when appropriate)

If they say over the phone, use the "buying specialist" trigger phrase tool in your sign off message as you are just in admin.

Note: One question at a time per interaction.
`]},
      { group: "Phone Up Follow Up", items: [`
Phone Up Follow Up

If the chat history indicates that the most recent agent to be activated is the "Fresh Up Follow Up" Agent, 

This means we are reaching out to a customer who out to customers who called the dealership 7 days ago & the conversation objective is to Invite them to visit the store and set an appointment.

1.0 - We will be (re) introducing ourselves and asking how their vehicle search is. (We are skipping the assistant working from home message here in this convo.). This will be a short "Hey [their name], how are you? Its [your name] from [ dealership name]. I had a quick note here to reach out, how is the vehicle search going?" message.

2.0 - Once they tell us how they / their vehicle search is we want to ackowledge what they say empathetically and then continue with the defauklt qualified prospect section and any booking related criteria.

The best way to book an appointment is to schedule a call with a specialist who will walk them through any final things we need etc.

One question at a time per interaction.
`]},
      { group: "Internet Up Follow Up", items: [`
Internet Up Follow Up

If the chat history indicates that the most recent agent to be activated is the "Fresh Up Follow Up" Agent, 

This means we are reaching out to a customer who is a brand new internet lead & the conversation objective is to Invite them to set an appointment in our store.

1.0 - We will be (re) introducing ourselves and asking how their vehicle search is. (We are skipping the assistant working from home message here in this convo.). This will be a short "Hey [their name], how are you? Its [your name] from [ dealership name]. I had a quick note here to reach out, how is the vehicle search going?" message.

2.0 - Once they tell us how they / their vehicle search is we want to ackowledge what they say empathetically and then continue with the defauklt qualified prospect section and any booking related criteria.

The best way to book an appointment is to schedule a call with a specialist who will walk them through any final things we need etc.

One question at a time per interaction.
`]}
    ]
  };

  const locationId   = get("locationId");
  const businessName = get("businessName");

  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const showOverlay = (t="Loadingâ€¦") => { overlayText.textContent=t; overlay.classList.remove("hidden"); };
  const hideOverlay = () => overlay.classList.add("hidden");

  const respBox = document.getElementById("respBox");
  const respPre = document.getElementById("respPre");
  function showWebhookResponse(json){
    // Try to present as: [ { data: [...] } ]
    let out;
    if (Array.isArray(json) && json.length && json[0].data) {
      out = json;
    } else if (json && Array.isArray(json.data)) {
      out = [{ data: json.data }];
    } else {
      out = [json];
    }
    respPre.textContent = JSON.stringify(out, null, 2);
    respBox.classList.remove("hidden");
  }

  // Header
  document.getElementById("locLine").textContent = locationId ? `Location: ${locationId}` : "Location ID missing";
  document.getElementById("bizLine").textContent = businessName ? `Business: ${businessName}` : "";

  // Refresh button
  document.getElementById("refreshBtn").addEventListener("click", ()=> location.reload());

  // Tabs
  const tabsEl = document.getElementById("tabs");
  for (let i=1;i<=AGENTS;i++){
    const t = document.createElement("button");
    t.className = "tab" + (i===1?" active":"");
    t.textContent = `Agent ${i}`;
    t.dataset.agent = i;
    t.setAttribute("aria-selected", i===1 ? "true" : "false");
    t.onclick = () => switchAgent(i);
    tabsEl.appendChild(t);
  }

  // Elements
  const agentChip    = document.getElementById("agentChip");
  const copyPrevBtn  = document.getElementById("copyPrevBtn");
  const copyNote     = document.getElementById("copyNote");

  const toggle       = document.getElementById("activeToggle");
  const activeLabel  = document.getElementById("activeLabel");
  const campaignName = document.getElementById("campaignName");
  const objTrigger   = document.getElementById("objTrigger");
  const objWebhook   = document.getElementById("objWebhook");
  const perDay       = document.getElementById("perDay");
  const cadence      = document.getElementById("cadence");
  const firstMessage = document.getElementById("firstMessage");
  const bump1        = document.getElementById("bump1");
  const bump2        = document.getElementById("bump2");
  const bump3        = document.getElementById("bump3");
  const notes        = document.getElementById("notes");
  const statusEl     = document.getElementById("status");
  const actionsRow   = document.getElementById("actionsRow");
  const submitBtn    = document.getElementById("submitBtn");
  const saveNextBtn  = document.getElementById("saveNextBtn");

  const cv = {
    active:   document.getElementById("cv_active"),
    campaign: document.getElementById("cv_campaign"),
    objTrigger: document.getElementById("cv_objTrigger"),
    objWebhook: document.getElementById("cv_objWebhook"),
    perday:   document.getElementById("cv_perday"),
    cadence:  document.getElementById("cv_cadence"),
    firstmsg: document.getElementById("cv_firstmsg"),
    bump1:    document.getElementById("cv_bump1"),
    bump2:    document.getElementById("cv_bump2"),
    bump3:    document.getElementById("cv_bump3"),
    notes:    document.getElementById("cv_notes"),
  };

  // Working/current snapshots
  const working = {};
  const current = {};
  let agent = 1;

  // Defaults for bumps
  const BUMP1_DEFAULT = "Hopefully I have the right number â€” is this {{contact.first_name}}?";
  const BUMP2_DEFAULT = "Just making sure Iâ€™ve got the right person â€” is this {{contact.first_name}}?";
  const BUMP3_DEFAULT = "Just circling back {{contact.first_name}}. Need any help from us at {{location.name}}?";

  // Toggle behavior
  function setActive(on){
    toggle.classList.toggle("on", !!on);
    toggle.setAttribute("aria-checked", !!on);
    activeLabel.textContent = on ? "Yes" : "No";
    recalcSaveVisibility();
  }
  toggle.addEventListener("click", ()=> setActive(!toggle.classList.contains("on")));
  toggle.addEventListener("keydown", (e)=>{ if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggle.click(); }});

  // Token inserter
  function insertTokenInto(el, token){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    const cur   = el.value || "";
    el.value = cur.slice(0,start) + token + cur.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + token.length;
    recalcSaveVisibility();
  }
  document.querySelectorAll(".ti").forEach(ti=>{
    const target = document.getElementById(ti.dataset.target);
    const sel = ti.querySelector("select");
    const btn = ti.querySelector("button");
    btn.addEventListener("click", ()=> insertTokenInto(target, sel.value));
  });

  // Listen to inputs â†’ recompute save button visibility
  [campaignName,objTrigger,objWebhook,perDay,cadence,firstMessage,bump1,bump2,bump3,notes].forEach(el=>{
    el.addEventListener("input", recalcSaveVisibility);
    el.addEventListener("change", recalcSaveVisibility);
  });

  function setStatus(text, ok){
    if (!text){ statusEl.textContent=""; return; }
    statusEl.textContent = text;
    statusEl.style.color = ok ? "#86efac" : "#a7b0c0";
  }
  function setCV(el, value){
    const has = !!(value && String(value).trim());
    el.innerHTML = `<strong>Current value:</strong> ${has ? String(value) : "(not set)"}`;
    el.classList.toggle("has-value", has);
    el.classList.toggle("empty", !has);
  }

  // Keys for agent
  function cvKeys(n){
    const base = `custom_campaign_agent_${n}__`;
    return {
      active:   base + "active_yes_or_leave_blank",
      bump1:    base + "bump_1",
      bump2:    base + "bump_2",
      bump3:    base + "bump_3",
      campaign: base + "campaign_name",
      firstmsg: base + "first_message",
      cadence:  base + "follow_up_cadence",
      perday:   base + "how_many_per_day_see_sop",
      notes:    base + "notes_about_campaign",
      objTrigger: base + "objective_reached_trigger_phrase",
      objWebhook: base + "objective_reached_webhook_endpoint"
    };
  }
  function overrideKeysFromQuery(kmap, n){
    const map = {...kmap};
    for (const field of Object.keys(map)){
      const q = qs.get(`key_${field}_${n}`);
      if (q) map[field] = q;
    }
    return map;
  }

  function renderCV(){
    setCV(cv.active,     current[agent]?.active);
    setCV(cv.campaign,   current[agent]?.campaign);
    setCV(cv.objTrigger, current[agent]?.objectiveTrigger);
    setCV(cv.objWebhook, current[agent]?.objectiveWebhook);
    setCV(cv.perday,     current[agent]?.perday);
    setCV(cv.cadence,    current[agent]?.cadence);
    setCV(cv.firstmsg,   current[agent]?.firstmsg);
    setCV(cv.bump1,      current[agent]?.bump1);
    setCV(cv.bump2,      current[agent]?.bump2);
    setCV(cv.bump3,      current[agent]?.bump3);
    setCV(cv.notes,      current[agent]?.notes);
  }

  function switchAgent(n){
    // persist working draft for current agent
    working[agent] = getFormValues();

    // switch tab highlight
    [...tabsEl.children].forEach(btn=>{
      const is = Number(btn.dataset.agent)===n;
      btn.classList.toggle("active", is);
      btn.setAttribute("aria-selected", is ? "true" : "false");
    });

    agent = n;
    agentChip.textContent = `Custom campaign agent ${agent}`;
    submitBtn.textContent = `Save Agent ${agent}`;
    document.title = `Agent ${agent} â€¢ Custom agent set up`;

    copyPrevBtn.style.display = agent === 1 ? "none" : "inline-flex";
    copyNote.textContent = "";

    const w = working[agent] || {};
    const prevIndex = agent === 1 ? AGENTS : agent - 1;
    const curA = current[agent] || {};
    const prevA = current[prevIndex] || {};

    campaignName.value = w.campaign || curA.campaign || prevA.campaign || "";
    objTrigger.value   = w.objectiveTrigger || curA.objectiveTrigger || prevA.objectiveTrigger || "";
    objWebhook.value   = w.objectiveWebhook || curA.objectiveWebhook || prevA.objectiveWebhook || "";
    perDay.value       = w.perday   || curA.perday   || prevA.perday   || perDay.value;
    cadence.value      = w.cadence  || curA.cadence  || prevA.cadence  || cadence.value;
    firstMessage.value = w.firstmsg || curA.firstmsg || prevA.firstmsg || "";
    bump1.value        = w.bump1    || curA.bump1    || prevA.bump1    || BUMP1_DEFAULT;
    bump2.value        = w.bump2    || curA.bump2    || prevA.bump2    || BUMP2_DEFAULT;
    bump3.value        = w.bump3    || curA.bump3    || prevA.bump3    || BUMP3_DEFAULT;
    notes.value        = w.notes    || curA.notes    || prevA.notes    || "";

    const activeSeed = (w.active || curA.active || prevA.active || "");
    setActive( activeSeed.toLowerCase()==="yes" );

    renderCV();
    recalcSaveVisibility();
    setStatus("");
    respBox.classList.add("hidden"); // hide old webhook output when switching
  }

  function getFormValues(){
    return {
      active:   toggle.classList.contains("on") ? "Yes" : "",
      campaign: campaignName.value.trim(),
      objectiveTrigger: objTrigger.value.trim(),
      objectiveWebhook: objWebhook.value.trim(),
      perday:   perDay.value,
      cadence:  cadence.value,
      firstmsg: firstMessage.value,
      bump1:    bump1.value,
      bump2:    bump2.value,
      bump3:    bump3.value,
      notes:    notes.value
    };
  }

  function isBlankTextFields(){
    // "all empty" considers text inputs / textareas + active toggle; ignores selects
    const v = getFormValues();
    const emptyActive = v.active==="";
    const emptyTexts =
      !v.campaign && !v.objectiveTrigger && !v.objectiveWebhook &&
      !v.firstmsg &&
      (!v.bump1 || v.bump1.trim()===BUMP1_DEFAULT) &&
      (!v.bump2 || v.bump2.trim()===BUMP2_DEFAULT) &&
      (!v.bump3 || v.bump3.trim()===BUMP3_DEFAULT) &&
      !v.notes;
    return emptyActive && emptyTexts;
  }

  function diffData(n, { ignoreDefaults=false } = {}){
    const now = getFormValues();
    const cur = current[n] || {};
    const labels = {
      active:   `Custom campaign agent ${n} â€“ Active`,
      campaign: `Custom campaign agent ${n} â€“ Campaign name`,
      objectiveTrigger: `Custom campaign agent ${n} â€“ Objective reached trigger phrase`,
      objectiveWebhook: `Custom campaign agent ${n} â€“ Objective reached webhook Endpoint`,
      perday:   `Custom campaign agent ${n} â€“ How many per day`,
      cadence:  `Custom campaign agent ${n} â€“ Follow up cadence`,
      firstmsg: `Custom campaign agent ${n} â€“ First message`,
      bump1:    `Custom campaign agent ${n} â€“ Bump 1`,
      bump2:    `Custom campaign agent ${n} â€“ Bump 2`,
      bump3:    `Custom campaign agent ${n} â€“ Bump 3`,
      notes:    `Custom campaign agent ${n} â€“ Notes about campaign`
    };

    const changed = {};
    for (const k of Object.keys(labels)){
      let after = now[k] ?? "";
      const before = cur[k] ?? "";
      if (ignoreDefaults){
        if (k==="bump1" && after.trim()===BUMP1_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump2" && after.trim()===BUMP2_DEFAULT.trim() && !before.trim()) continue;
        if (k==="bump3" && after.trim()===BUMP3_DEFAULT.trim() && !before.trim()) continue;
      }
      if (String(before) !== String(after)) changed[ labels[k] ] = after;
    }
    return changed;
  }

  function recalcSaveVisibility(){
    const noChanges = Object.keys(diffData(agent, { ignoreDefaults:true })).length===0;
    const allEmpty  = isBlankTextFields();
    const show = !(noChanges || allEmpty);
    actionsRow.classList.toggle("hidden", !show);
  }

  // Save single (changed-only)
  submitBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);
    if (!SUBMIT_URL) return setStatus("Missing submitUrl in query string.", false);
    await saveAgentThenRefresh(agent, { jumpToNext:false });
  });

  // Save & Next
  saveNextBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!locationId) return setStatus("Missing locationId", false);
    if (!SUBMIT_URL) return setStatus("Missing submitUrl in query string.", false);
    await saveAgentThenRefresh(agent, { jumpToNext:true });
  });

  async function saveAgentThenRefresh(agentNum, { jumpToNext }){
    const changed = diffData(agentNum, { ignoreDefaults:false });
    if (!Object.keys(changed).length){
      setStatus("No changes to save.", true);
      return;
    }

    let keysFull = overrideKeysFromQuery(cvKeys(agentNum), agentNum);
    const rev = {
      [`Custom campaign agent ${agentNum} â€“ Active`] : "active",
      [`Custom campaign agent ${agentNum} â€“ Campaign name`] : "campaign",
      [`Custom campaign agent ${agentNum} â€“ Objective reached trigger phrase`] : "objTrigger",
      [`Custom campaign agent ${agentNum} â€“ Objective reached webhook Endpoint`] : "objWebhook",
      [`Custom campaign agent ${agentNum} â€“ How many per day`] : "perday",
      [`Custom campaign agent ${agentNum} â€“ Follow up cadence`] : "cadence",
      [`Custom campaign agent ${agentNum} â€“ First message`] : "firstmsg",
      [`Custom campaign agent ${agentNum} â€“ Bump 1`] : "bump1",
      [`Custom campaign agent ${agentNum} â€“ Bump 2`] : "bump2",
      [`Custom campaign agent ${agentNum} â€“ Bump 3`] : "bump3",
      [`Custom campaign agent ${agentNum} â€“ Notes about campaign`] : "notes"
    };
    const keysSubset = {};
    for (const label of Object.keys(changed)){
      const k = rev[label]; if (k) keysSubset[k] = keysFull[k];
    }

    const payload = { locationId, businessName, agent: agentNum, keys: keysSubset, data: changed };

    submitBtn.disabled = true; saveNextBtn.disabled = true;
    showOverlay("Savingâ€¦");

    try{
      const res = await fetch(SUBMIT_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=> ({}));
      hideOverlay();
      setStatus("Saved", true);
      showWebhookResponse(json);

      setTimeout(async ()=>{
        await refreshFromServer();
        if (jumpToNext){
          const next = agentNum === AGENTS ? 1 : agentNum + 1;
          switchAgent(next);
        }
      }, 3000);
    }catch{
      setStatus("Network error. Try again."); hideOverlay();
    }finally{
      submitBtn.disabled = false; saveNextBtn.disabled = false;
    }
  }

  async function refreshFromServer(){
    if (!locationId) return;
    if (!FETCH_URL){ setStatus("Missing fetchUrl in query string.", false); return; }
    showOverlay("Refreshingâ€¦");
    const urlWithBust = FETCH_URL + (FETCH_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    try{
      const res = await fetch(urlWithBust, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers: buildHeaders(),
        body: JSON.stringify({ locationId })
      });
      const json = await res.json().catch(()=> ({}));
      const agents = json?.agents || {};
      for (let i=1;i<=AGENTS;i++){
        const a = agents[String(i)] || agents[i] || {};
        current[i] = {
          active:   a.active ?? "",
          campaign: a.campaign ?? "",
          objectiveTrigger: a.objectiveTrigger ?? a.objective_trigger ?? "",
          objectiveWebhook: a.objectiveWebhook ?? a.objective_webhook ?? "",
          perday:   a.perday ?? "",
          cadence:  a.cadence ?? "",
          firstmsg: a.firstmsg ?? "",
          bump1:    a.bump1 ?? "",
          bump2:    a.bump2 ?? "",
          bump3:    a.bump3 ?? "",
          notes:    a.notes ?? ""
        };
      }
      renderCV();
      recalcSaveVisibility();
      setStatus("Refreshed", true);
    }catch{
      setStatus("Could not refresh current values.", false);
    }finally{
      hideOverlay();
    }
  }

  // Copy from previous agent (CURRENT values)
  copyPrevBtn.addEventListener("click", ()=>{
    const prev = agent === 1 ? AGENTS : agent - 1;
    const src = current[prev] || {};
    setActive((src.active || "").toLowerCase()==="yes");
    campaignName.value = src.campaign || "";
    objTrigger.value   = src.objectiveTrigger || "";
    objWebhook.value   = src.objectiveWebhook || "";
    perDay.value       = src.perday   || perDay.value;
    cadence.value      = src.cadence  || cadence.value;
    firstMessage.value = src.firstmsg || "";
    bump1.value        = src.bump1    || BUMP1_DEFAULT;
    bump2.value        = src.bump2    || BUMP2_DEFAULT;
    bump3.value        = src.bump3    || BUMP3_DEFAULT;
    notes.value        = src.notes    || "";
    copyNote.textContent = `Copied values from Agent ${prev}.`;
    setTimeout(()=> copyNote.textContent="", 3500);
    recalcSaveVisibility();
  });

  // Examples modal logic
  const exModal = document.getElementById("exModal");
  const exList  = document.getElementById("exList");
  const exClose = document.getElementById("exClose");
  document.querySelectorAll(".ex-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const kind = btn.dataset.kind;             // first | bump1 | bump2 | bump3 | notes
      const targetId = btn.dataset.target;       // textarea id
      const groups = EXAMPLES[kind] || [];
      exList.innerHTML = "";
      document.getElementById("exTitle").textContent = `Examples â€” ${kind.replace(/^./,c=>c.toUpperCase())}`;
      groups.forEach(g=>{
        const block = document.createElement("div");
        block.className = "ex-group";
        const h = document.createElement("h4"); h.textContent = g.group;
        block.appendChild(h);
        (g.items||[]).forEach(txt=>{
          const row = document.createElement("div");
          row.className = "ex-item";
          const p = document.createElement("div");
          p.className = "ex-text";
          p.textContent = txt.trim();
          const use = document.createElement("button");
          use.className = "usebtn";
          use.textContent = "Use";
          use.onclick = () => {
            const field = document.getElementById(targetId);
            field.value = txt.trim();
            exModal.classList.remove("show");
            field.focus();
            recalcSaveVisibility();
          };
          row.appendChild(p); row.appendChild(use);
          block.appendChild(row);
        });
        exList.appendChild(block);
      });
      exModal.classList.add("show");
    });
  });
  exClose.addEventListener("click", ()=> exModal.classList.remove("show"));
  exModal.addEventListener("click", (e)=>{ if (e.target===exModal) exModal.classList.remove("show"); });

  (async function init(){
    for (let i=1;i<=AGENTS;i++){ working[i]={}; current[i]={}; }
    if (!locationId){ setStatus("Missing locationId", false); return; }
    showOverlay("Loading current valuesâ€¦");
    await refreshFromServer();  // hides overlay
    switchAgent(1);
  })();
</script>
</body>
</html>
